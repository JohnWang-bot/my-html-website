<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生成绩奖励计算器</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#22c55e',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#0ea5e9',
                        light: '#f8fafc',
                        dark: '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-in': 'slideIn 0.5s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        fadeOut: {
                            '0%': { opacity: '1' },
                            '100%': { opacity: '0' },
                        },
                        slideIn: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- 登录界面 -->
        <div id="login-screen" class="animate-fade-in">
            <div class="flex justify-center items-center min-h-[80vh]">
                <div class="w-full max-w-md">
                    <div class="text-center mb-10">
                        <h1 class="text-4xl font-bold text-primary text-shadow mb-2">学生成绩奖励计算器</h1>
                        <p class="text-gray-600">高效管理学生成绩，智能计算奖励</p>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-xl p-8 glass">
                        <div class="flex mb-6">
                            <button id="login-tab" class="flex-1 py-3 text-center border-b-2 border-primary text-primary font-medium">登录</button>
                            <button id="register-tab" class="flex-1 py-3 text-center border-b-2 border-gray-200 text-gray-500 font-medium">注册</button>
                        </div>
                        
                        <!-- 登录表单 -->
                        <div id="login-form" class="space-y-6 animate-slide-in">
                            <div>
                                <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                                <input type="text" id="login-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入用户名">
                            </div>
                            <div>
                                <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                                <div class="relative">
                                    <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入密码">
                                    <button type="button" id="toggle-login-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-all-300">
                                        <i class="fa fa-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <input type="checkbox" id="remember-me" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                                    <label for="remember-me" class="ml-2 block text-sm text-gray-700">记住密码</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="admin-login" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                                    <label for="admin-login" class="ml-2 block text-sm text-gray-700">管理员登录</label>
                                </div>
                            </div>
                            <button id="login-button" class="w-full bg-primary hover:bg-blue-600 text-white font-medium py-2.5 px-4 rounded-lg transition-all-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary shadow-lg hover:shadow-xl">
                                登录
                            </button>
                        </div>
                        
                        <!-- 注册表单 -->
                        <div id="register-form" class="space-y-6 hidden animate-slide-in">
                            <div>
                                <label for="register-username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                                <input type="text" id="register-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入用户名">
                            </div>
                            <div>
                                <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                                <div class="relative">
                                    <input type="password" id="register-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入密码">
                                    <button type="button" id="toggle-register-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-all-300">
                                        <i class="fa fa-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">确认密码</label>
                                <div class="relative">
                                    <input type="password" id="confirm-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请再次输入密码">
                                    <button type="button" id="toggle-confirm-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-all-300">
                                        <i class="fa fa-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                            <button id="register-button" class="w-full bg-primary hover:bg-blue-600 text-white font-medium py-2.5 px-4 rounded-lg transition-all-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary shadow-lg hover:shadow-xl">
                                注册
                            </button>
                        </div>
                    </div>
                    
                    <!-- 快速登录 -->
                    <div class="mt-8">
                        <h3 class="text-center text-gray-700 font-medium mb-4">快速登录</h3>
                        <div id="quick-login" class="grid grid-cols-2 gap-4">
                            <!-- 快速登录用户将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 用户界面 -->
        <div id="user-screen" class="hidden animate-fade-in">
            <header class="bg-white shadow-md rounded-lg mb-6 p-4 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-primary">学生成绩奖励计算器</h2>
                    <p class="text-gray-600" id="user-greeting">欢迎回来，用户</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="settings-button" class="text-gray-600 hover:text-primary transition-all-300">
                        <i class="fa fa-cog text-xl"></i>
                    </button>
                    <button id="help-button" class="text-gray-600 hover:text-primary transition-all-300">
                        <i class="fa fa-question-circle text-xl"></i>
                    </button>
                    <button id="logout-button" class="bg-danger hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                        退出登录
                    </button>
                </div>
            </header>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 奖励规则说明 -->
                <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-1">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-info-circle text-primary mr-2"></i>奖励规则说明
                    </h3>
                    <div class="space-y-4 text-gray-700" id="reward-rules">
                        <p class="text-gray-600">正在加载奖励规则...</p>
                    </div>
                </div>
                
                <!-- 成绩录入 -->
                <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-2">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-pencil-square-o text-primary mr-2"></i>成绩录入
                    </h3>
                    <form id="score-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">科目</label>
                                <select id="subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300">
                                    <option value="">请选择科目</option>
                                    <option value="语文">语文</option>
                                    <option value="数学">数学</option>
                                    <option value="英语">英语</option>
                                    <option value="物理">物理</option>
                                    <option value="化学">化学</option>
                                    <option value="生物">生物</option>
                                    <option value="历史">历史</option>
                                    <option value="地理">地理</option>
                                    <option value="政治">政治</option>
                                </select>
                            </div>
                            <div>
                                <label for="score" class="block text-sm font-medium text-gray-700 mb-1">成绩</label>
                                <input type="number" id="score" min="0" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入成绩">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="exam-type" class="block text-sm font-medium text-gray-700 mb-1">考试类型</label>
                                <select id="exam-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300">
                                    <option value="">请选择考试类型</option>
                                    <option value="期中考试">期中考试</option>
                                    <option value="期末考试">期末考试</option>
                                    <option value="月考">月考</option>
                                    <option value="模拟考试">模拟考试</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            <div>
                                <label for="exam-date" class="block text-sm font-medium text-gray-700 mb-1">考试日期</label>
                                <input type="date" id="exam-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300">
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button type="submit" id="add-score-button" class="bg-primary hover:bg-blue-600 text-white font-medium py-2.5 px-4 rounded-lg transition-all-300 flex items-center">
                                <i class="fa fa-plus-circle mr-2"></i>确认录入
                            </button>
                            <button type="button" id="calculate-reward-button" class="bg-success hover:bg-green-600 text-white font-medium py-2.5 px-4 rounded-lg transition-all-300 flex items-center">
                                <i class="fa fa-calculator mr-2"></i>计算奖励
                            </button>
                        </div>
                    </form>
                    
                    <!-- 当前录入的成绩 -->
                    <div class="mt-6" id="current-scores-section">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">当前录入成绩</h4>
                        
                        <!-- 所有科目录入完成提示 -->
                        <div id="all-subjects-notification" class="hidden"></div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">科目</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">满分值</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">成绩</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">奖罚额</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">考试类型</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">考试日期</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="current-scores-list">
                                    <!-- 当前录入的成绩将通过JS动态生成 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 成绩汇总信息 -->
                        <div id="score-summary" class="hidden mt-4 bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-gray-800 mb-2">成绩汇总</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <p class="text-gray-600 text-sm">科目数</p>
                                    <p id="summary-subject-count" class="text-xl font-bold text-gray-800">0</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-gray-600 text-sm">总成绩</p>
                                    <p id="summary-total-score" class="text-xl font-bold text-gray-800">0</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-gray-600 text-sm">奖罚总额</p>
                                    <p id="summary-total-reward" class="text-xl font-bold text-gray-800">0元</p>
                                </div>
                            </div>
                            <!-- 提交确认按钮已移除 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 奖励历史记录 -->
            <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa fa-history text-primary mr-2"></i>奖励历史记录
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg overflow-hidden">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">序号</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">科目</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">满分值</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">成绩</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">奖罚额</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">考试类型</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">考试日期</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">计算时间</th>
                            </tr>
                        </thead>
                        <tbody id="reward-history-list">
                            <!-- 奖励历史记录将通过JS动态生成 -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <p class="text-gray-600">共 <span id="total-records">0</span> 条记录</p>
                    <div class="flex space-x-2">
                        <button id="prev-page" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-1 px-3 rounded transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fa fa-chevron-left"></i>
                        </button>
                        <span id="current-page" class="py-1 px-3">1</span>
                        <button id="next-page" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-1 px-3 rounded transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fa fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 管理员界面 -->
        <div id="admin-screen" class="hidden animate-fade-in">
            <header class="bg-white shadow-md rounded-lg mb-6 p-4 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-primary">学生成绩奖励计算器 - 管理员界面</h2>
                    <p class="text-gray-600">管理员，您可以管理所有用户和设置</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="admin-help-button" class="text-gray-600 hover:text-primary transition-all-300">
                        <i class="fa fa-question-circle text-xl"></i>
                    </button>
                    <button id="admin-logout-button" class="bg-danger hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                        退出登录
                    </button>
                </div>
            </header>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex mb-6 border-b">
                    <button id="user-management-tab" class="py-3 px-6 text-center border-b-2 border-primary text-primary font-medium">用户管理</button>
                    <button id="reward-records-tab" class="py-3 px-6 text-center border-b-2 border-gray-200 text-gray-500 font-medium">奖励记录管理</button>
                    <button id="grade-subject-tab" class="py-3 px-6 text-center border-b-2 border-gray-200 text-gray-500 font-medium">年级/科目管理</button>
                    <button id="reward-rules-tab" class="py-3 px-6 text-center border-b-2 border-gray-200 text-gray-500 font-medium">奖励规则管理</button>
                    <button id="admin-settings-tab" class="py-3 px-6 text-center border-b-2 border-gray-200 text-gray-500 font-medium">管理员设置</button>
                </div>
                
                <!-- 用户管理 -->
                <div id="user-management-content" class="animate-slide-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">所有用户账号管理</h3>
                        <button id="add-user-button" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300 flex items-center">
                            <i class="fa fa-plus mr-2"></i>添加用户
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">用户名</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">年级</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">科目数量</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">注册时间</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">操作</th>
                                </tr>
                            </thead>
                            <tbody id="users-list">
                                <!-- 用户列表将通过JS动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 奖励记录管理 -->
                <div id="reward-records-content" class="hidden animate-slide-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">所有用户奖励记录管理</h3>
                        <div class="flex items-center space-x-2">
                            <select id="admin-user-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300">
                                <option value="all">所有用户</option>
                            </select>
                            <button id="refresh-records-button" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300 flex items-center">
                                <i class="fa fa-refresh mr-2"></i>刷新
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">序号</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">用户</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">考试信息</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">科目数</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">总成绩</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">奖罚额</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">计算时间</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">操作</th>
                                </tr>
                            </thead>
                            <tbody id="admin-reward-records-list">
                                <!-- 奖励记录列表将通过JS动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <span id="admin-total-records" class="text-sm text-gray-600">总记录数: 0</span>
                        <div class="flex items-center space-x-2">
                            <button id="admin-prev-page" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-1 px-3 rounded-lg transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <span id="admin-current-page" class="text-sm font-medium">1</span>
                            <button id="admin-next-page" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-1 px-3 rounded-lg transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 年级/科目管理 -->
                <div id="grade-subject-content" class="hidden animate-slide-in">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 年级管理 -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">年级管理</h3>
                                <button id="add-grade-button" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300 flex items-center">
                                    <i class="fa fa-plus mr-2"></i>添加年级
                                </button>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <ul id="grades-list" class="space-y-2">
                                    <!-- 年级列表将通过JS动态生成 -->
                                </ul>
                            </div>
                        </div>
                        
                        <!-- 科目管理 -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">科目管理</h3>
                                <button id="add-subject-button" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300 flex items-center">
                                    <i class="fa fa-plus mr-2"></i>添加科目
                                </button>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <ul id="subjects-list" class="space-y-2">
                                    <!-- 科目列表将通过JS动态生成 -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 奖励规则管理 -->
                <div id="reward-rules-content" class="hidden animate-slide-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">奖励规则管理</h3>
                        <button id="add-rule-button" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300 flex items-center">
                            <i class="fa fa-plus mr-2"></i>添加规则
                        </button>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">成绩范围</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">奖罚额</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">描述</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">操作</th>
                                </tr>
                            </thead>
                            <tbody id="rules-list">
                                <!-- 规则列表将通过JS动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 管理员设置 -->
                <div id="admin-settings-content" class="hidden animate-slide-in">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">管理员账号设置</h3>
                    <div class="max-w-md">
                        <form id="admin-settings-form" class="space-y-4">
                            <div>
                                <label for="current-admin-password" class="block text-sm font-medium text-gray-700 mb-1">当前密码</label>
                                <div class="relative">
                                    <input type="password" id="current-admin-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入当前密码">
                                    <button type="button" id="toggle-current-admin-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-all-300">
                                        <i class="fa fa-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="new-admin-password" class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
                                <div class="relative">
                                    <input type="password" id="new-admin-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入新密码">
                                    <button type="button" id="toggle-new-admin-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-all-300">
                                        <i class="fa fa-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="confirm-admin-password" class="block text-sm font-medium text-gray-700 mb-1">确认新密码</label>
                                <div class="relative">
                                    <input type="password" id="confirm-admin-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请再次输入新密码">
                                    <button type="button" id="toggle-confirm-admin-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-all-300">
                                        <i class="fa fa-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="submit" id="change-admin-password-button" class="bg-primary hover:bg-blue-600 text-white font-medium py-2.5 px-4 rounded-lg transition-all-300 flex items-center">
                                <i class="fa fa-save mr-2"></i>修改密码
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 帮助模态框 -->
        <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full mx-4 animate-slide-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">使用帮助</h3>
                    <button id="close-help-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-4 text-gray-700">
                    <div>
                        <h4 class="font-semibold text-gray-800">登录/注册</h4>
                        <p>请使用您的用户名和密码登录系统。如果您还没有账号，请点击注册按钮创建新账号。</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">成绩录入</h4>
                        <p>在用户界面中，您可以录入学生的各科成绩，包括科目、成绩、考试类型和考试日期。</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">奖励计算</h4>
                        <p>系统会根据录入的成绩自动计算奖励积分。您可以在奖励规则说明中查看具体的奖励标准。</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">历史记录</h4>
                        <p>系统会保存所有的成绩和奖励记录，您可以在奖励历史记录中查看详细信息。</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">管理员功能</h4>
                        <p>管理员可以管理用户账号、年级/科目设置以及奖励规则。请使用管理员账号登录以访问这些功能。</p>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <button id="close-help-button" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                        我知道了
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 添加用户模态框 -->
        <div id="add-user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 animate-slide-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">添加用户</h3>
                    <button id="close-add-user-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <form id="add-user-form" class="space-y-4">
                    <div>
                        <label for="new-username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                        <input type="text" id="new-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入用户名">
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                        <div class="relative">
                            <input type="password" id="new-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入密码">
                            <button type="button" id="toggle-new-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-all-300">
                                <i class="fa fa-eye-slash"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="new-grade" class="block text-sm font-medium text-gray-700 mb-1">年级</label>
                        <div class="relative">
                            <input type="text" id="new-grade" list="grade-options" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请选择或输入年级">
                            <datalist id="grade-options">
                                <option value="初一">
                                <option value="初二">
                                <option value="初三">
                                <option value="高一">
                                <option value="高二">
                                <option value="高三">
                            </datalist>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">提示：可以选择现有年级或直接输入新的年级名称</p>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-add-user" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all-300">
                            取消
                        </button>
                        <button type="submit" id="confirm-add-user" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                            确认添加
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 添加年级模态框 -->
        <div id="add-grade-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 animate-slide-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">添加年级</h3>
                    <button id="close-add-grade-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <form id="add-grade-form" class="space-y-4">
                    <div>
                        <label for="new-grade-name" class="block text-sm font-medium text-gray-700 mb-1">年级名称</label>
                        <input type="text" id="new-grade-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入年级名称">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-add-grade" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all-300">
                            取消
                        </button>
                        <button type="submit" id="confirm-add-grade" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                            确认添加
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 添加科目模态框 -->
        <div id="add-subject-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 animate-slide-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">添加科目</h3>
                    <button id="close-add-subject-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <form id="add-subject-form" class="space-y-4">
                    <div>
                        <label for="new-subject-name" class="block text-sm font-medium text-gray-700 mb-1">科目名称</label>
                        <input type="text" id="new-subject-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入科目名称">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-add-subject" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all-300">
                            取消
                        </button>
                        <button type="submit" id="confirm-add-subject" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                            确认添加
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 添加规则模态框 -->
        <div id="add-rule-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 animate-slide-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">添加奖励规则</h3>
                    <button id="close-add-rule-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <form id="add-rule-form" class="space-y-4">
                    <div>
                        <label for="min-score" class="block text-sm font-medium text-gray-700 mb-1">最低分数</label>
                        <input type="number" id="min-score" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入最低分数">
                    </div>
                    <div>
                        <label for="max-score" class="block text-sm font-medium text-gray-700 mb-1">最高分数</label>
                        <input type="number" id="max-score" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入最高分数">
                    </div>
                    <div>
                        <label for="reward-points" class="block text-sm font-medium text-gray-700 mb-1">奖励积分</label>
                        <input type="number" id="reward-points" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入奖励积分">
                    </div>
                    <div>
                        <label for="rule-description" class="block text-sm font-medium text-gray-700 mb-1">规则描述</label>
                        <input type="text" id="rule-description" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="请输入规则描述">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-add-rule" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all-300">
                            取消
                        </button>
                        <button type="submit" id="confirm-add-rule" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                            确认添加
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 用户科目管理模态框 -->
        <div id="user-subjects-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 animate-slide-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">用户科目管理</h3>
                    <button id="close-user-subjects-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 当前科目 -->
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-3">当前科目</h4>
                        <div class="bg-gray-50 p-4 rounded-lg h-64 overflow-y-auto">
                            <ul id="current-subjects-list" class="space-y-2">
                                <!-- 当前科目将通过JS动态生成 -->
                            </ul>
                        </div>
                    </div>
                    <!-- 可选科目 -->
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-3">可选科目</h4>
                        <div class="bg-gray-50 p-4 rounded-lg h-64 overflow-y-auto">
                            <ul id="available-subjects-list" class="space-y-2">
                                <!-- 可选科目将通过JS动态生成 -->
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- 自定义科目添加 -->
                <div class="mt-4">
                    <h4 class="font-semibold text-gray-800 mb-2">添加自定义科目</h4>
                    <div class="flex space-x-2">
                        <input type="text" id="custom-subject-name" placeholder="科目名称" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        <input type="number" id="custom-subject-full-score" placeholder="满分值" min="0" max="1000" value="100" class="w-24 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        <button id="add-custom-subject" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                            添加
                        </button>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button id="save-user-subjects" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                        保存更改
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 用户奖励规则管理模态框 -->
        <div id="user-rules-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full mx-4 animate-slide-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">用户奖励规则管理</h3>
                    <button id="close-user-rules-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <form id="user-rules-form" class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-primary mb-2">规则说明</h4>
                        <ul class="text-sm text-gray-600 space-y-1">
                            <li><strong>及格线</strong>：低于此分数线将受到处罚</li>
                            <li><strong>奖励线</strong>：高于此分数线将获得每分10元奖励</li>
                            <li><strong>双倍奖励线</strong>：高于此分数线将获得每分20元奖励</li>
                            <li>所有分数线均按满分的百分比计算</li>
                        </ul>
                    </div>
                    <div>
                        <label for="pass-percentage" class="block text-gray-700 font-medium mb-2">及格线百分比 (%)</label>
                        <input type="number" id="pass-percentage" min="0" max="100" value="60" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="reward-percentage" class="block text-gray-700 font-medium mb-2">奖励线百分比 (%)</label>
                        <input type="number" id="reward-percentage" min="0" max="100" value="90" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="double-reward-percentage" class="block text-gray-700 font-medium mb-2">双倍奖励线百分比 (%)</label>
                        <input type="number" id="double-reward-percentage" min="0" max="100" value="96" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="penalty-amount" class="block text-gray-700 font-medium mb-2">处罚金额 (元/科)</label>
                        <input type="number" id="penalty-amount" min="0" value="10" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancel-user-rules" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all-300">
                            取消
                        </button>
                        <button type="submit" id="save-user-rules" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                            保存规则
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 编辑科目模态框 -->
        <div id="edit-subject-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 animate-slide-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">编辑科目</h3>
                    <button id="close-edit-subject-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <form id="edit-subject-form" class="space-y-4">
                    <div>
                        <label for="edit-subject-name" class="block text-gray-700 font-medium mb-2">科目名称</label>
                        <input type="text" id="edit-subject-name" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" readonly>
                    </div>
                    <div>
                        <label for="edit-subject-full-score" class="block text-gray-700 font-medium mb-2">满分值</label>
                        <input type="number" id="edit-subject-full-score" min="0" max="1000" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancel-edit-subject" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all-300">
                            取消
                        </button>
                        <button type="submit" id="save-edit-subject" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 用户个人信息设置模态框 -->
        <div id="user-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 animate-slide-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">个人信息设置</h3>
                    <button id="close-user-settings-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <form id="user-settings-form" class="space-y-4">
                    <div>
                        <label for="user-settings-username" class="block text-gray-700 font-medium mb-2">用户名</label>
                        <input type="text" id="user-settings-username" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="user-settings-grade" class="block text-gray-700 font-medium mb-2">年级</label>
                        <div class="relative">
                            <input type="text" id="user-settings-grade" list="user-grade-options" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="请选择或输入年级">
                            <datalist id="user-grade-options">
                                <option value="初一">
                                <option value="初二">
                                <option value="初三">
                                <option value="高一">
                                <option value="高二">
                                <option value="高三">
                            </datalist>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">提示：可以选择现有年级或直接输入新的年级名称</p>
                    </div>
                    <div>
                        <label for="user-settings-password" class="block text-gray-700 font-medium mb-2">修改密码</label>
                        <div class="relative">
                            <input type="password" id="user-settings-password" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="留空表示不修改密码">
                            <button type="button" id="toggle-user-settings-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-all-300">
                                <i class="fa fa-eye-slash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancel-user-settings" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all-300">
                            取消
                        </button>
                        <button type="submit" id="save-user-settings" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 计算奖励结果模态框 -->
        <div id="reward-result-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 animate-slide-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">奖励计算结果</h3>
                    <button id="close-reward-result-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <!-- 用户信息 -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-800 mb-2">用户信息</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-600 text-sm">用户名:</p>
                                <p class="font-bold text-gray-800" id="user-info-name">-</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">年级:</p>
                                <p class="font-bold text-gray-800" id="user-info-grade">-</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-primary mb-2">总体成绩统计</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <p class="text-gray-600">科目数量:</p>
                                <p class="font-bold text-gray-800" id="total-subjects">0</p>
                            </div>
                            <div>
                                <p class="text-gray-600">平均成绩:</p>
                                <p class="font-bold text-gray-800" id="average-score">0</p>
                            </div>
                            <div>
                                <p class="text-gray-600">最高成绩:</p>
                                <p class="font-bold text-success" id="highest-score">0</p>
                            </div>
                            <div>
                                <p class="text-gray-600">最低成绩:</p>
                                <p class="font-bold text-danger" id="lowest-score">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-success mb-2">奖励积分</h4>
                        <div class="flex justify-center items-center">
                            <div class="text-center">
                                <p class="text-gray-600">总奖励积分:</p>
                                <p class="text-4xl font-bold text-success" id="total-reward-points">0</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">详细奖励</h4>
                        <div id="detailed-rewards" class="space-y-2">
                            <!-- 详细奖励将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button id="save-reward-button" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300 flex items-center">
                        <i class="fa fa-save mr-2"></i>保存记录
                    </button>
                    <button id="close-reward-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all-300">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 数据存储
        let users = [
            { id: 1, username: 'admin', password: 'admin123', isAdmin: true, grade: '管理员', registerTime: '2023-01-01', lastLoginTime: null, subjects: [] },
            { id: 2, username: 'user1', password: 'user123', isAdmin: false, grade: '高一', registerTime: '2023-02-01', lastLoginTime: '2024-01-20T10:30:00.000Z', subjects: [
                { name: '语文', fullScore: 100 },
                { name: '数学', fullScore: 100 },
                { name: '英语', fullScore: 100 }
            ], userRules: {
                passPercentage: 60,
                rewardPercentage: 90,
                doubleRewardPercentage: 96,
                penaltyAmount: 10
            }},
            { id: 3, username: 'user2', password: 'user123', isAdmin: false, grade: '高二', registerTime: '2023-03-01', lastLoginTime: '2024-01-20T09:15:00.000Z', subjects: [
                { name: '语文', fullScore: 100 },
                { name: '数学', fullScore: 100 },
                { name: '英语', fullScore: 100 },
                { name: '物理', fullScore: 100 },
                { name: '化学', fullScore: 100 }
            ], userRules: {
                passPercentage: 60,
                rewardPercentage: 90,
                doubleRewardPercentage: 96,
                penaltyAmount: 10
            }},
            { id: 4, username: 'user3', password: 'user123', isAdmin: false, grade: '高三', registerTime: '2023-04-01', lastLoginTime: '2024-01-20T08:45:00.000Z', subjects: [
                { name: '语文', fullScore: 100 },
                { name: '数学', fullScore: 100 },
                { name: '英语', fullScore: 100 },
                { name: '物理', fullScore: 100 },
                { name: '化学', fullScore: 100 },
                { name: '生物', fullScore: 100 }
            ], userRules: {
                passPercentage: 60,
                rewardPercentage: 90,
                doubleRewardPercentage: 96,
                penaltyAmount: 10
            }},
            { id: 5, username: 'user4', password: 'user123', isAdmin: false, grade: '初三', registerTime: '2023-05-01', lastLoginTime: '2024-01-20T07:20:00.000Z', subjects: [
                { name: '语文', fullScore: 100 },
                { name: '数学', fullScore: 100 },
                { name: '英语', fullScore: 100 },
                { name: '物理', fullScore: 100 },
                { name: '化学', fullScore: 100 },
                { name: '历史', fullScore: 100 },
                { name: '地理', fullScore: 100 },
                { name: '政治', fullScore: 100 }
            ], userRules: {
                passPercentage: 60,
                rewardPercentage: 90,
                doubleRewardPercentage: 96,
                penaltyAmount: 10
            }}
        ];
        
        let grades = ['初一', '初二', '初三', '高一', '高二', '高三'];
        
        let subjects = [
            { name: '语文', fullScore: 100 },
            { name: '数学', fullScore: 100 },
            { name: '英语', fullScore: 100 },
            { name: '物理', fullScore: 100 },
            { name: '化学', fullScore: 100 },
            { name: '生物', fullScore: 100 },
            { name: '历史', fullScore: 100 },
            { name: '地理', fullScore: 100 },
            { name: '政治', fullScore: 100 },
            { name: '体育', fullScore: 100 },
            { name: '音乐', fullScore: 100 },
            { name: '美术', fullScore: 100 },
            { name: '信息技术', fullScore: 100 },
            { name: '通用技术', fullScore: 100 }
        ];
        
        let rewardRules = [
            { id: 1, minScore: 96, maxScore: 100, points: 20, description: '双倍奖励线 (每分20元)' },
            { id: 2, minScore: 90, maxScore: 95, points: 10, description: '奖励线 (每分10元)' },
            { id: 3, minScore: 60, maxScore: 89, points: 0, description: '及格线 (不奖不罚)' },
            { id: 4, minScore: 0, maxScore: 59, points: -10, description: '处罚线 (每科扣10元)' }
        ];
        
        let currentUser = null;
        let currentScores = [];
        let rewardHistory = [];
        let currentPage = 1;
        const recordsPerPage = 10;
        let adminCurrentPage = 1;
        const adminRecordsPerPage = 10;
        
        // DOM 加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化登录界面
            initLoginScreen();
            
            // 初始化用户界面
            initUserScreen();
            
            // 初始化管理员界面
            initAdminScreen();
            
            // 初始化模态框
            initModals();
            
            // 设置当前日期为默认考试日期
            function setCurrentDate() {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                const formattedToday = `${yyyy}-${mm}-${dd}`;
                document.getElementById('exam-date').value = formattedToday;
            }
            setCurrentDate();
        });
        
        // 初始化登录界面
        function initLoginScreen() {
            // 登录和注册标签切换
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            loginTab.addEventListener('click', function() {
                loginTab.classList.add('border-primary', 'text-primary');
                loginTab.classList.remove('border-gray-200', 'text-gray-500');
                registerTab.classList.add('border-gray-200', 'text-gray-500');
                registerTab.classList.remove('border-primary', 'text-primary');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            });
            
            registerTab.addEventListener('click', function() {
                registerTab.classList.add('border-primary', 'text-primary');
                registerTab.classList.remove('border-gray-200', 'text-gray-500');
                loginTab.classList.add('border-gray-200', 'text-gray-500');
                loginTab.classList.remove('border-primary', 'text-primary');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            });
            
            // 密码显示切换
            const toggleLoginPassword = document.getElementById('toggle-login-password');
            const loginPassword = document.getElementById('login-password');
            
            toggleLoginPassword.addEventListener('click', function() {
                togglePasswordVisibility(loginPassword, toggleLoginPassword);
            });
            
            const toggleRegisterPassword = document.getElementById('toggle-register-password');
            const registerPassword = document.getElementById('register-password');
            
            toggleRegisterPassword.addEventListener('click', function() {
                togglePasswordVisibility(registerPassword, toggleRegisterPassword);
            });
            
            const toggleConfirmPassword = document.getElementById('toggle-confirm-password');
            const confirmPassword = document.getElementById('confirm-password');
            
            toggleConfirmPassword.addEventListener('click', function() {
                togglePasswordVisibility(confirmPassword, toggleConfirmPassword);
            });
            
            // 登录按钮点击事件
            const loginButton = document.getElementById('login-button');
            loginButton.addEventListener('click', handleLogin);
            
            // 注册按钮点击事件
            const registerButton = document.getElementById('register-button');
            registerButton.addEventListener('click', handleRegister);
            
            // 生成快速登录用户
            generateQuickLoginUsers();
        }
        
        // 初始化用户界面
        function initUserScreen() {
            // 退出登录按钮点击事件
            const logoutButton = document.getElementById('logout-button');
            logoutButton.addEventListener('click', handleLogout);
            
            // 设置按钮点击事件
            const settingsButton = document.getElementById('settings-button');
            settingsButton.addEventListener('click', function() {
                // 填充当前用户信息
                document.getElementById('user-settings-username').value = currentUser.username;
                document.getElementById('user-settings-grade').value = currentUser.grade;
                document.getElementById('user-settings-password').value = '';
                
                // 更新年级选项
                updateGradeOptions();
                
                // 显示设置模态框
                document.getElementById('user-settings-modal').classList.remove('hidden');
            });
            
            // 帮助按钮点击事件
            const helpButton = document.getElementById('help-button');
            helpButton.addEventListener('click', function() {
                document.getElementById('help-modal').classList.remove('hidden');
            });
            
            // 成绩表单提交事件
            const scoreForm = document.getElementById('score-form');
            scoreForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addScore();
            });
            
            // 重置表单功能（在确认录入后自动调用）
            
            // 计算奖励按钮点击事件
            const calculateRewardButton = document.getElementById('calculate-reward-button');
            calculateRewardButton.addEventListener('click', calculateReward);
            
            // 提交确认按钮点击事件已移除
            
            // 分页按钮点击事件
            const prevPageButton = document.getElementById('prev-page');
            const nextPageButton = document.getElementById('next-page');
            
            prevPageButton.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    updateRewardHistory();
                }
            });
            
            nextPageButton.addEventListener('click', function() {
                const totalPages = Math.ceil(rewardHistory.length / recordsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    updateRewardHistory();
                }
            });
            
            // 成绩输入实时计算奖励
            const scoreInput = document.getElementById('score');
            const subjectSelect = document.getElementById('subject');
            
            function updateRealtimeReward() {
                const score = parseFloat(scoreInput.value);
                const subject = subjectSelect.value;
                
                if (!isNaN(score) && subject) {
                    const reward = calculateSingleReward(subject, score);
                    const rewardText = reward >= 0 ? `+${reward}元` : `${reward}元`;
                    const rewardClass = reward > 0 ? 'text-success' : reward < 0 ? 'text-danger' : 'text-gray-700';
                    
                    document.getElementById('realtime-reward').innerHTML = `
                        奖励: <span class="${rewardClass} font-bold">${rewardText}</span>
                    `;
                } else {
                    document.getElementById('realtime-reward').innerHTML = '奖励: 0元';
                }
            }
            
            scoreInput.addEventListener('input', updateRealtimeReward);
            subjectSelect.addEventListener('change', updateRealtimeReward);
        }
        
        // 初始化管理员界面
        function initAdminScreen() {
            // 初始化奖励记录管理事件
            initAdminRewardRecordsEvents();
            
            // 管理员界面标签切换
            const userManagementTab = document.getElementById('user-management-tab');
            const rewardRecordsTab = document.getElementById('reward-records-tab');
            const gradeSubjectTab = document.getElementById('grade-subject-tab');
            const rewardRulesTab = document.getElementById('reward-rules-tab');
            const adminSettingsTab = document.getElementById('admin-settings-tab');
            
            const userManagementContent = document.getElementById('user-management-content');
            const rewardRecordsContent = document.getElementById('reward-records-content');
            const gradeSubjectContent = document.getElementById('grade-subject-content');
            const rewardRulesContent = document.getElementById('reward-rules-content');
            const adminSettingsContent = document.getElementById('admin-settings-content');
            
            userManagementTab.addEventListener('click', function() {
                setActiveTab(userManagementTab, userManagementContent);
                setInactiveTab(rewardRecordsTab, rewardRecordsContent);
                setInactiveTab(gradeSubjectTab, gradeSubjectContent);
                setInactiveTab(rewardRulesTab, rewardRulesContent);
                setInactiveTab(adminSettingsTab, adminSettingsContent);
                updateUsersList();
            });
            
            rewardRecordsTab.addEventListener('click', function() {
                setInactiveTab(userManagementTab, userManagementContent);
                setActiveTab(rewardRecordsTab, rewardRecordsContent);
                setInactiveTab(gradeSubjectTab, gradeSubjectContent);
                setInactiveTab(rewardRulesTab, rewardRulesContent);
                setInactiveTab(adminSettingsTab, adminSettingsContent);
                updateAdminRewardRecords();
            });
            
            gradeSubjectTab.addEventListener('click', function() {
                setInactiveTab(userManagementTab, userManagementContent);
                setInactiveTab(rewardRecordsTab, rewardRecordsContent);
                setActiveTab(gradeSubjectTab, gradeSubjectContent);
                setInactiveTab(rewardRulesTab, rewardRulesContent);
                setInactiveTab(adminSettingsTab, adminSettingsContent);
                updateGradesList();
                updateSubjectsList();
            });
            
            rewardRulesTab.addEventListener('click', function() {
                setInactiveTab(userManagementTab, userManagementContent);
                setInactiveTab(rewardRecordsTab, rewardRecordsContent);
                setInactiveTab(gradeSubjectTab, gradeSubjectContent);
                setActiveTab(rewardRulesTab, rewardRulesContent);
                setInactiveTab(adminSettingsTab, adminSettingsContent);
                updateRulesList();
            });
            
            adminSettingsTab.addEventListener('click', function() {
                setInactiveTab(userManagementTab, userManagementContent);
                setInactiveTab(rewardRecordsTab, rewardRecordsContent);
                setInactiveTab(gradeSubjectTab, gradeSubjectContent);
                setInactiveTab(rewardRulesTab, rewardRulesContent);
                setActiveTab(adminSettingsTab, adminSettingsContent);
            });
            
            // 管理员退出登录按钮点击事件
            const adminLogoutButton = document.getElementById('admin-logout-button');
            adminLogoutButton.addEventListener('click', handleLogout);
            
            // 管理员帮助按钮点击事件
            const adminHelpButton = document.getElementById('admin-help-button');
            adminHelpButton.addEventListener('click', function() {
                document.getElementById('help-modal').classList.remove('hidden');
            });
            
            // 添加用户按钮点击事件
            const addUserButton = document.getElementById('add-user-button');
            addUserButton.addEventListener('click', function() {
                document.getElementById('add-user-modal').classList.remove('hidden');
            });
            
            // 添加用户表单提交事件
            const addUserForm = document.getElementById('add-user-form');
            addUserForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addUser();
            });
            
            // 添加年级按钮点击事件
            const addGradeButton = document.getElementById('add-grade-button');
            addGradeButton.addEventListener('click', function() {
                document.getElementById('add-grade-modal').classList.remove('hidden');
            });
            
            // 添加年级表单提交事件
            const addGradeForm = document.getElementById('add-grade-form');
            addGradeForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addGrade();
            });
            
            // 添加科目按钮点击事件
            const addSubjectButton = document.getElementById('add-subject-button');
            addSubjectButton.addEventListener('click', function() {
                document.getElementById('add-subject-modal').classList.remove('hidden');
            });
            
            // 添加科目表单提交事件
            const addSubjectForm = document.getElementById('add-subject-form');
            addSubjectForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addSubject();
            });
            
            // 添加规则按钮点击事件
            const addRuleButton = document.getElementById('add-rule-button');
            addRuleButton.addEventListener('click', function() {
                document.getElementById('add-rule-modal').classList.remove('hidden');
            });
            
            // 添加规则表单提交事件
            const addRuleForm = document.getElementById('add-rule-form');
            addRuleForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addRule();
            });
            
            // 管理员密码修改表单提交事件
            const adminSettingsForm = document.getElementById('admin-settings-form');
            adminSettingsForm.addEventListener('submit', function(e) {
                e.preventDefault();
                changeAdminPassword();
            });
            
            // 管理员密码显示切换
            const toggleCurrentAdminPassword = document.getElementById('toggle-current-admin-password');
            const currentAdminPassword = document.getElementById('current-admin-password');
            
            toggleCurrentAdminPassword.addEventListener('click', function() {
                togglePasswordVisibility(currentAdminPassword, toggleCurrentAdminPassword);
            });
            
            const toggleNewAdminPassword = document.getElementById('toggle-new-admin-password');
            const newAdminPassword = document.getElementById('new-admin-password');
            
            toggleNewAdminPassword.addEventListener('click', function() {
                togglePasswordVisibility(newAdminPassword, toggleNewAdminPassword);
            });
            
            const toggleConfirmAdminPassword = document.getElementById('toggle-confirm-admin-password');
            const confirmAdminPassword = document.getElementById('confirm-admin-password');
            
            toggleConfirmAdminPassword.addEventListener('click', function() {
                togglePasswordVisibility(confirmAdminPassword, toggleConfirmAdminPassword);
            });
            
            // 添加用户密码显示切换
            const toggleNewPassword = document.getElementById('toggle-new-password');
            const newPassword = document.getElementById('new-password');
            
            toggleNewPassword.addEventListener('click', function() {
                togglePasswordVisibility(newPassword, toggleNewPassword);
            });
        }
        
        // 初始化模态框
        function initModals() {
            // 用户科目管理模态框关闭按钮
            const closeUserSubjectsModal = document.getElementById('close-user-subjects-modal');
            const saveUserSubjects = document.getElementById('save-user-subjects');
            const addCustomSubject = document.getElementById('add-custom-subject');
            
            closeUserSubjectsModal.addEventListener('click', function() {
                document.getElementById('user-subjects-modal').classList.add('hidden');
                currentManagingUser = null;
            });
            
            saveUserSubjects.addEventListener('click', saveUserSubjectsChanges);
            
            addCustomSubject.addEventListener('click', function() {
                const customSubjectName = document.getElementById('custom-subject-name').value.trim();
                const customSubjectFullScore = parseInt(document.getElementById('custom-subject-full-score').value);
                
                if (!customSubjectName) {
                    alert('请输入科目名称！');
                    return;
                }
                
                if (isNaN(customSubjectFullScore) || customSubjectFullScore <= 0) {
                    alert('请输入有效的满分值！');
                    return;
                }
                
                // 检查科目是否已存在
                const subjectExists = subjects.some(s => s.name === customSubjectName);
                if (subjectExists) {
                    alert('该科目已存在！');
                    return;
                }
                
                // 添加新科目
                const newSubject = {
                    name: customSubjectName,
                    fullScore: customSubjectFullScore
                };
                
                subjects.push(newSubject);
                
                // 清空输入框
                document.getElementById('custom-subject-name').value = '';
                document.getElementById('custom-subject-full-score').value = '100';
                
                // 如果当前正在管理用户科目，则刷新列表
                if (currentManagingUser) {
                    manageUserSubjects(currentManagingUser.id);
                }
                
                // 更新科目列表
                updateSubjectsList();
                
                alert('自定义科目添加成功！');
            });
            
            // 取消按钮已移除，改为点击关闭按钮直接关闭
            
            // 编辑科目模态框事件监听
            const closeEditSubjectModal = document.getElementById('close-edit-subject-modal');
            const cancelEditSubject = document.getElementById('cancel-edit-subject');
            const editSubjectForm = document.getElementById('edit-subject-form');
            
            closeEditSubjectModal.addEventListener('click', function() {
                document.getElementById('edit-subject-modal').classList.add('hidden');
            });
            
            cancelEditSubject.addEventListener('click', function() {
                document.getElementById('edit-subject-modal').classList.add('hidden');
            });
            
            editSubjectForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveEditedSubject();
            });
            
            // 用户奖励规则管理模态框事件监听
            const closeUserRulesModal = document.getElementById('close-user-rules-modal');
            const cancelUserRules = document.getElementById('cancel-user-rules');
            const userRulesForm = document.getElementById('user-rules-form');
            
            closeUserRulesModal.addEventListener('click', function() {
                document.getElementById('user-rules-modal').classList.add('hidden');
            });
            
            cancelUserRules.addEventListener('click', function() {
                document.getElementById('user-rules-modal').classList.add('hidden');
            });
            
            userRulesForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveUserRules();
            });
            // 帮助模态框关闭按钮
            const closeHelpModal = document.getElementById('close-help-modal');
            const closeHelpButton = document.getElementById('close-help-button');
            
            closeHelpModal.addEventListener('click', function() {
                document.getElementById('help-modal').classList.add('hidden');
            });
            
            closeHelpButton.addEventListener('click', function() {
                document.getElementById('help-modal').classList.add('hidden');
            });
            
            // 添加用户模态框关闭按钮
            const closeAddUserModal = document.getElementById('close-add-user-modal');
            const cancelAddUser = document.getElementById('cancel-add-user');
            
            closeAddUserModal.addEventListener('click', function() {
                document.getElementById('add-user-modal').classList.add('hidden');
            });
            
            cancelAddUser.addEventListener('click', function() {
                document.getElementById('add-user-modal').classList.add('hidden');
            });
            
            // 添加年级模态框关闭按钮
            const closeAddGradeModal = document.getElementById('close-add-grade-modal');
            const cancelAddGrade = document.getElementById('cancel-add-grade');
            
            closeAddGradeModal.addEventListener('click', function() {
                document.getElementById('add-grade-modal').classList.add('hidden');
            });
            
            cancelAddGrade.addEventListener('click', function() {
                document.getElementById('add-grade-modal').classList.add('hidden');
            });
            
            // 添加科目模态框关闭按钮
            const closeAddSubjectModal = document.getElementById('close-add-subject-modal');
            const cancelAddSubject = document.getElementById('cancel-add-subject');
            
            closeAddSubjectModal.addEventListener('click', function() {
                document.getElementById('add-subject-modal').classList.add('hidden');
            });
            
            cancelAddSubject.addEventListener('click', function() {
                document.getElementById('add-subject-modal').classList.add('hidden');
            });
            
            // 添加规则模态框关闭按钮
            const closeAddRuleModal = document.getElementById('close-add-rule-modal');
            const cancelAddRule = document.getElementById('cancel-add-rule');
            
            closeAddRuleModal.addEventListener('click', function() {
                document.getElementById('add-rule-modal').classList.add('hidden');
            });
            
            cancelAddRule.addEventListener('click', function() {
                document.getElementById('add-rule-modal').classList.add('hidden');
            });
            
            // 用户个人信息设置模态框事件监听
            const closeUserSettingsModal = document.getElementById('close-user-settings-modal');
            const cancelUserSettings = document.getElementById('cancel-user-settings');
            const userSettingsForm = document.getElementById('user-settings-form');
            const toggleUserSettingsPassword = document.getElementById('toggle-user-settings-password');
            const userSettingsPassword = document.getElementById('user-settings-password');
            
            closeUserSettingsModal.addEventListener('click', function() {
                document.getElementById('user-settings-modal').classList.add('hidden');
            });
            
            cancelUserSettings.addEventListener('click', function() {
                document.getElementById('user-settings-modal').classList.add('hidden');
            });
            
            userSettingsForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveUserSettings();
            });
            
            toggleUserSettingsPassword.addEventListener('click', function() {
                togglePasswordVisibility(userSettingsPassword, toggleUserSettingsPassword);
            });
            
            // 奖励结果模态框关闭按钮
            const closeRewardResultModal = document.getElementById('close-reward-result-modal');
            const closeRewardButton = document.getElementById('close-reward-button');
            const saveRewardButton = document.getElementById('save-reward-button');
            
            closeRewardResultModal.addEventListener('click', function() {
                document.getElementById('reward-result-modal').classList.add('hidden');
            });
            
            closeRewardButton.addEventListener('click', function() {
                document.getElementById('reward-result-modal').classList.add('hidden');
            });
            
            saveRewardButton.addEventListener('click', saveRewardRecord);
        }
        
        // 切换密码可见性
        function togglePasswordVisibility(passwordInput, toggleButton) {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.innerHTML = '<i class="fa fa-eye"></i>';
            } else {
                passwordInput.type = 'password';
                toggleButton.innerHTML = '<i class="fa fa-eye-slash"></i>';
            }
        }
        
        // 设置活动标签
        function setActiveTab(tab, content) {
            tab.classList.add('border-primary', 'text-primary');
            tab.classList.remove('border-gray-200', 'text-gray-500');
            content.classList.remove('hidden');
        }
        
        // 设置非活动标签
        function setInactiveTab(tab, content) {
            tab.classList.add('border-gray-200', 'text-gray-500');
            tab.classList.remove('border-primary', 'text-primary');
            content.classList.add('hidden');
        }
        
        // 生成快速登录用户
        function generateQuickLoginUsers() {
            const quickLoginContainer = document.getElementById('quick-login');
            quickLoginContainer.innerHTML = '';
            
            // 获取最近登录的4个用户（排除管理员），按最后登录时间降序排序
            const recentUsers = users
                .filter(user => !user.isAdmin)
                .sort((a, b) => {
                    const timeA = a.lastLoginTime ? new Date(a.lastLoginTime).getTime() : 0;
                    const timeB = b.lastLoginTime ? new Date(b.lastLoginTime).getTime() : 0;
                    return timeB - timeA; // 降序排序，最近登录的在前
                })
                .slice(0, 4);
            
            recentUsers.forEach(user => {
                const userButton = document.createElement('button');
                userButton.className = 'bg-white hover:bg-blue-50 text-gray-800 font-medium py-3 px-4 rounded-lg border border-gray-200 transition-all-300 flex flex-col items-center';
                
                // 显示最后登录时间
                let lastLoginText = '';
                if (user.lastLoginTime) {
                    const lastLogin = new Date(user.lastLoginTime);
                    const now = new Date();
                    const diffMs = now - lastLogin;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    if (diffMins < 60) {
                        lastLoginText = `${diffMins}分钟前`;
                    } else if (diffHours < 24) {
                        lastLoginText = `${diffHours}小时前`;
                    } else {
                        lastLoginText = `${diffDays}天前`;
                    }
                } else {
                    lastLoginText = '从未登录';
                }
                
                userButton.innerHTML = `
                    <i class="fa fa-user-circle text-2xl text-primary mb-2"></i>
                    <span>${user.username}</span>
                    <span class="text-xs text-gray-500">${user.grade}</span>
                    <span class="text-xs text-gray-400">${lastLoginText}</span>
                `;
                userButton.addEventListener('click', function() {
                    // 自动填充用户名和密码
                    document.getElementById('login-username').value = user.username;
                    document.getElementById('login-password').value = user.password;
                });
                quickLoginContainer.appendChild(userButton);
            });
        }
        
        // 处理登录
        function handleLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const isAdminLogin = document.getElementById('admin-login').checked;
            
            // 查找用户
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                if (isAdminLogin && !user.isAdmin) {
                    alert('该用户不是管理员！');
                    return;
                }
                
                if (!isAdminLogin && user.isAdmin) {
                    alert('请勾选管理员登录！');
                    return;
                }
                
                currentUser = user;
                
                // 更新用户最后登录时间
                user.lastLoginTime = new Date().toISOString();
                
                // 显示相应的界面
                if (user.isAdmin) {
                    showAdminScreen();
                } else {
                    showUserScreen();
                }
            } else {
                alert('用户名或密码错误！');
            }
        }
        
        // 处理注册
        function handleRegister() {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // 验证用户名是否已存在
            if (users.some(user => user.username === username)) {
                alert('用户名已存在！');
                return;
            }
            
            // 验证密码
            if (password !== confirmPassword) {
                alert('两次输入的密码不一致！');
                return;
            }
            
            // 创建新用户
            const newUser = {
                id: users.length + 1,
                username: username,
                password: password,
                isAdmin: false,
                grade: '未分配',
                registerTime: new Date().toISOString().split('T')[0],
                lastLoginTime: null,
                subjects: [
                    { name: '语文', fullScore: 100 },
                    { name: '数学', fullScore: 100 },
                    { name: '英语', fullScore: 100 }
                ],
                userRules: {
                    passPercentage: 60,
                    rewardPercentage: 75,
                    doubleRewardPercentage: 80,
                    penaltyAmount: 10
                }
            };
            
            users.push(newUser);
            
            // 切换到登录标签
            document.getElementById('login-tab').click();
            
            // 清空注册表单
            document.getElementById('register-username').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('confirm-password').value = '';
            
            // 更新快速登录用户
            generateQuickLoginUsers();
            
            alert('注册成功！请登录。');
        }
        
        // 处理退出登录
        function handleLogout() {
            currentUser = null;
            currentScores = [];
            currentPage = 1;
            
            // 清空表单
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('admin-login').checked = false;
            
            // 显示登录界面
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('user-screen').classList.add('hidden');
            document.getElementById('admin-screen').classList.add('hidden');
        }
        
        // 显示用户界面
        function showUserScreen() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('user-screen').classList.remove('hidden');
            document.getElementById('admin-screen').classList.add('hidden');
            
            // 更新用户问候语
            document.getElementById('user-greeting').textContent = `欢迎回来，${currentUser.username}（${currentUser.grade}）`;
            
            // 更新科目选择下拉框
            updateSubjectSelect();
            
            // 更新奖励规则显示
            updateUserRulesDisplay();
            
            // 清空当前录入的成绩
            currentScores = [];
            updateCurrentScoresList();
            
            // 更新奖励历史记录
            updateRewardHistory();
        }
        
        // 更新科目选择下拉框
        function updateSubjectSelect() {
            const subjectSelect = document.getElementById('subject');
            subjectSelect.innerHTML = '';
            
            // 添加默认选项
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '请选择科目';
            subjectSelect.appendChild(defaultOption);
            
            // 如果用户有分配的科目，则只显示这些科目
            if (currentUser && currentUser.subjects && currentUser.subjects.length > 0) {
                currentUser.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.name;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
            } else {
                // 否则显示所有科目
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.name;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
            }
        }
        
        // 显示管理员界面
        function showAdminScreen() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('user-screen').classList.add('hidden');
            document.getElementById('admin-screen').classList.remove('hidden');
            
            // 默认显示用户管理标签
            document.getElementById('user-management-tab').click();
        }
        
        // 添加成绩
        function addScore() {
            const subject = document.getElementById('subject').value;
            const score = parseFloat(document.getElementById('score').value);
            const examType = document.getElementById('exam-type').value;
            const examDate = document.getElementById('exam-date').value;
            
            // 验证输入
            if (!subject || !score || !examType || !examDate) {
                alert('请填写完整的成绩信息！');
                return;
            }
            
            // 获取科目满分值
            const subjectObj = currentUser.subjects.find(s => s.name === subject);
            const fullScore = subjectObj ? subjectObj.fullScore : 100;
            
            // 验证成绩范围
            if (score < 0 || score > fullScore) {
                alert(`成绩必须在0-${fullScore}之间！`);
                return;
            }
            
            // 检查是否已经录入过该科目
            const existingScoreIndex = currentScores.findIndex(s => s.subject === subject);
            if (existingScoreIndex !== -1) {
                if (confirm('该科目已录入成绩，是否覆盖？')) {
                    currentScores[existingScoreIndex].score = score;
                    currentScores[existingScoreIndex].examType = examType;
                    currentScores[existingScoreIndex].examDate = examDate;
                } else {
                    return;
                }
            } else {
                // 添加新成绩
                const newScore = {
                    id: currentScores.length + 1,
                    subject: subject,
                    score: score,
                    examType: examType,
                    examDate: examDate
                };
                
                currentScores.push(newScore);
            }
            
            // 更新当前成绩列表
            updateCurrentScoresList();
            
            // 重置表单
            resetScoreForm();
            
            // 检查是否所有科目都已录入
            checkAllSubjectsEntered();
        }
        
        // 重置成绩表单
        function resetScoreForm() {
            document.getElementById('subject').value = '';
            document.getElementById('score').value = '';
            document.getElementById('exam-type').value = '';
            setCurrentDate(); // 重置为当前日期
        }
        
        // 更新当前成绩列表
        function updateCurrentScoresList() {
            const currentScoresList = document.getElementById('current-scores-list');
            currentScoresList.innerHTML = '';
            
            if (currentScores.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="7" class="py-4 text-center text-gray-500">暂无录入的成绩</td>
                `;
                currentScoresList.appendChild(emptyRow);
                
                // 隐藏汇总信息
                document.getElementById('score-summary').classList.add('hidden');
                return;
            }
            
            let totalScore = 0;
            let totalReward = 0;
            
            currentScores.forEach(score => {
                // 获取科目满分值
                const subjectObj = currentUser.subjects.find(s => s.name === score.subject);
                const fullScore = subjectObj ? subjectObj.fullScore : 100;
                
                const reward = calculateSingleReward(score.subject, score.score);
                const rewardText = reward >= 0 ? `+${reward}元` : `${reward}元`;
                const rewardClass = reward > 0 ? 'text-success' : reward < 0 ? 'text-danger' : 'text-gray-500';
                
                // 累加总分和总奖励
                totalScore += score.score;
                totalReward += reward;
                
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-all-300';
                row.innerHTML = `
                    <td class="py-3 px-4">${score.subject}</td>
                    <td class="py-3 px-4">${fullScore}</td>
                    <td class="py-3 px-4">
                        <input type="number" value="${score.score}" min="0" max="${fullScore}" step="0.1" 
                               class="score-input w-20 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-primary focus:border-primary" 
                               onchange="updateScore(${score.id}, this.value)">
                    </td>
                    <td class="py-3 px-4">
                        <span class="${rewardClass} font-bold">${rewardText}</span>
                    </td>
                    <td class="py-3 px-4">${score.examType}</td>
                    <td class="py-3 px-4">${score.examDate}</td>
                    <td class="py-3 px-4">
                        <button class="text-danger hover:text-red-700 transition-all-300" onclick="removeScore(${score.id})">
                            <i class="fa fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                currentScoresList.appendChild(row);
            });
            
            // 更新汇总信息
            updateScoreSummary(currentScores.length, totalScore, totalReward);
        }
        
        // 检查是否所有科目都已录入
        function checkAllSubjectsEntered() {
            if (!currentUser || !currentUser.subjects || currentUser.subjects.length === 0) return;
            
            const enteredSubjects = currentScores.map(s => s.subject);
            const allSubjects = currentUser.subjects.map(s => s.name);
            
            const allEntered = allSubjects.every(subject => enteredSubjects.includes(subject));
            
            if (allEntered && currentScores.length > 0) {
                // 计算汇总信息
                let totalScore = currentScores.reduce((sum, s) => sum + s.score, 0);
                let totalReward = currentScores.reduce((sum, s) => sum + calculateSingleReward(s.subject, s.score), 0);
                
                // 显示提示信息
                const summaryHtml = `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fa fa-info-circle text-blue-500 text-xl"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    已完成所有 ${currentUser.subjects.length} 科目的成绩录入！
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                const summaryContainer = document.getElementById('all-subjects-notification');
                summaryContainer.innerHTML = summaryHtml;
                summaryContainer.classList.remove('hidden');
            }
        }
        
        // 更新成绩汇总信息
        function updateScoreSummary(subjectCount, totalScore, totalReward) {
            const summaryContainer = document.getElementById('score-summary');
            summaryContainer.classList.remove('hidden');
            
            document.getElementById('summary-subject-count').textContent = subjectCount;
            document.getElementById('summary-total-score').textContent = totalScore.toFixed(1);
            document.getElementById('summary-total-reward').textContent = (totalReward >= 0 ? '+' : '') + totalReward + '元';
            document.getElementById('summary-total-reward').className = totalReward > 0 ? 'text-success font-bold' : totalReward < 0 ? 'text-danger font-bold' : 'text-gray-700 font-bold';
        }
        
        // 删除成绩
        function removeScore(id) {
            currentScores = currentScores.filter(score => score.id !== id);
            updateCurrentScoresList();
        }
        
        // 更新成绩
        function updateScore(id, newScore) {
            const score = parseFloat(newScore);
            
            // 获取对应的科目满分值
            const scoreIndex = currentScores.findIndex(s => s.id === id);
            if (scoreIndex === -1) return;
            
            const subject = currentScores[scoreIndex].subject;
            const subjectObj = currentUser.subjects.find(s => s.name === subject);
            const fullScore = subjectObj ? subjectObj.fullScore : 100;
            
            if (isNaN(score) || score < 0 || score > fullScore) {
                alert(`请输入有效的成绩（0-${fullScore}）！`);
                updateCurrentScoresList(); // 重置为原始值
                return;
            }
            
            currentScores[scoreIndex].score = score;
            updateCurrentScoresList();
        }
        
        // 计算单个成绩的奖励
        function calculateSingleReward(subject, score) {
            // 获取科目满分值
            const subjectObj = currentUser.subjects.find(s => s.name === subject);
            const fullScore = subjectObj ? subjectObj.fullScore : 100;
            
            // 使用用户自定义规则或默认规则
            if (currentUser.userRules) {
                const userRules = currentUser.userRules;
                const passScore = (fullScore * userRules.passPercentage) / 100;
                const rewardScore = (fullScore * userRules.rewardPercentage) / 100;
                const doubleRewardScore = (fullScore * userRules.doubleRewardPercentage) / 100;
                
                if (score < passScore) {
                    // 处罚
                    return -userRules.penaltyAmount;
                } else if (score >= doubleRewardScore) {
                    // 双倍奖励 - 只计算超出标准的整数部分
                    const excessScore = Math.floor(score - doubleRewardScore);
                    return excessScore * 20;
                } else if (score >= rewardScore) {
                    // 奖励 - 只计算超出标准的整数部分
                    const excessScore = Math.floor(score - rewardScore);
                    return excessScore * 10;
                } else {
                    // 不奖不罚
                    return 0;
                }
            } else {
                // 使用默认规则
                const rule = rewardRules.find(r => score >= r.minScore && score <= r.maxScore);
                if (rule) {
                    if (rule.points > 0) {
                        // 只计算超出标准的整数部分
                        const excessScore = Math.floor(score - rule.minScore);
                        return excessScore * rule.points;
                    } else if (rule.points < 0) {
                        return rule.points;
                    }
                }
                return 0;
            }
        }
        
        // 计算奖励
        function calculateReward() {
            if (currentScores.length === 0) {
                alert('请先录入成绩！');
                return;
            }
            
            // 计算统计数据
            const totalScore = currentScores.reduce((sum, score) => sum + score.score, 0);
            const averageScore = totalScore / currentScores.length;
            const highestScore = Math.max(...currentScores.map(score => score.score));
            const lowestScore = Math.min(...currentScores.map(score => score.score));
            
            // 计算奖励金额
            let totalRewardPoints = 0;
            const detailedRewards = [];
            
            currentScores.forEach(score => {
                // 获取科目满分值
                const subject = currentUser.subjects.find(s => s.name === score.subject);
                const fullScore = subject ? subject.fullScore : 100;
                
                // 使用用户自定义规则或默认规则
                let points = 0;
                let description = '';
                
                if (currentUser.userRules) {
                    const userRules = currentUser.userRules;
                    const passScore = (fullScore * userRules.passPercentage) / 100;
                    const rewardScore = (fullScore * userRules.rewardPercentage) / 100;
                    const doubleRewardScore = (fullScore * userRules.doubleRewardPercentage) / 100;
                    
                    if (score.score < passScore) {
                        // 处罚
                        points = -userRules.penaltyAmount;
                        description = `低于及格线 (${userRules.passPercentage}%)`;
                    } else if (score.score >= doubleRewardScore) {
                        // 双倍奖励 - 只计算超出标准的整数部分
                        const excessScore = Math.floor(score.score - doubleRewardScore);
                        points = excessScore * 20;
                        description = `双倍奖励线 (${userRules.doubleRewardPercentage}%+, 每分20元)`;
                    } else if (score.score >= rewardScore) {
                        // 奖励 - 只计算超出标准的整数部分
                        const excessScore = Math.floor(score.score - rewardScore);
                        points = excessScore * 10;
                        description = `奖励线 (${userRules.rewardPercentage}%+, 每分10元)`;
                    } else {
                        // 不奖不罚
                        points = 0;
                        description = `及格线以上 (${userRules.passPercentage}%-${userRules.rewardPercentage}%)`;
                    }
                } else {
                    // 使用默认规则
                    const rule = rewardRules.find(r => score.score >= r.minScore && score.score <= r.maxScore);
                    if (rule) {
                        if (rule.points > 0) {
                            // 只计算超出标准的整数部分
                            const excessScore = Math.floor(score.score - rule.minScore);
                            points = excessScore * rule.points;
                        } else if (rule.points < 0) {
                            points = rule.points;
                        }
                        description = rule.description;
                    }
                }
                
                totalRewardPoints += points;
                
                detailedRewards.push({
                    subject: score.subject,
                    score: score.score,
                    fullScore: fullScore,
                    points: points,
                    description: description
                });
            });
            
            // 更新奖励结果模态框
            // 更新用户信息
            document.getElementById('user-info-name').textContent = currentUser.username;
            document.getElementById('user-info-grade').textContent = currentUser.grade;
            
            // 更新成绩统计
            document.getElementById('total-subjects').textContent = currentScores.length;
            document.getElementById('average-score').textContent = averageScore.toFixed(2);
            document.getElementById('highest-score').textContent = highestScore;
            document.getElementById('lowest-score').textContent = lowestScore;
            document.getElementById('total-reward-points').textContent = (totalRewardPoints >= 0 ? '+' : '') + totalRewardPoints + '元';
            
            // 更新详细奖励
            const detailedRewardsContainer = document.getElementById('detailed-rewards');
            detailedRewardsContainer.innerHTML = '';
            
            detailedRewards.forEach(reward => {
                const rewardItem = document.createElement('div');
                rewardItem.className = 'flex justify-between items-center p-2 bg-white rounded';
                rewardItem.innerHTML = `
                    <div>
                        <span class="font-medium">${reward.subject}: ${reward.score}分</span>
                        <span class="text-sm text-gray-500 ml-2">(${reward.description})</span>
                    </div>
                    <span class="font-bold ${reward.points > 0 ? 'text-success' : reward.points < 0 ? 'text-danger' : 'text-gray-500'}">${reward.points > 0 ? '+' : ''}${reward.points}元</span>
                `;
                detailedRewardsContainer.appendChild(rewardItem);
            });
            
            // 显示奖励结果模态框
            document.getElementById('reward-result-modal').classList.remove('hidden');
        }
        

        
        // 动态更新年级选项
        function updateGradeOptions() {
            const gradeOptions = document.getElementById('user-grade-options');
            if (!gradeOptions) return;
            
            // 清空现有选项
            gradeOptions.innerHTML = '';
            
            // 获取所有唯一的年级
            const uniqueGrades = [...new Set(users.map(user => user.grade).filter(grade => grade))];
            
            // 添加年级选项
            uniqueGrades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                gradeOptions.appendChild(option);
            });
        }

        // 保存用户个人信息
        function saveUserSettings() {
            const newUsername = document.getElementById('user-settings-username').value.trim();
            const grade = document.getElementById('user-settings-grade').value;
            const password = document.getElementById('user-settings-password').value;
            
            if (!newUsername) {
                alert('用户名不能为空！');
                return;
            }
             
             if (!grade) {
                 alert('请选择年级！');
                 return;
             }
             
             // 检查用户名是否已被其他用户使用
             const usernameExists = users.some(user => user.username === newUsername && user.id !== currentUser.id);
             if (usernameExists) {
                 alert('用户名已被使用，请选择其他用户名！');
                 return;
             }
            
            // 更新用户信息
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].username = newUsername;
                users[userIndex].grade = grade;
                
                // 如果输入了新密码，则更新密码
                if (password) {
                    users[userIndex].password = password;
                }
                
                // 更新当前用户对象
                currentUser = users[userIndex];
                
                // 更新欢迎信息
                document.getElementById('user-greeting').textContent = `欢迎回来，${currentUser.username} (${currentUser.grade})`;
                
                // 更新快速登录用户
                generateQuickLoginUsers();
                
                alert('个人信息更新成功！');
                document.getElementById('user-settings-modal').classList.add('hidden');
            } else {
                alert('用户不存在！');
            }
        }

        // 保存奖励记录
        function saveRewardRecord() {
            if (currentScores.length === 0) {
                alert('没有可保存的成绩！');
                return;
            }
            
            // 计算奖励金额
            let totalRewardPoints = 0;
            const detailedRewards = [];
            
            currentScores.forEach(score => {
                // 获取科目满分值
                const subject = currentUser.subjects.find(s => s.name === score.subject);
                const fullScore = subject ? subject.fullScore : 100;
                
                // 使用用户自定义规则或默认规则
                let points = 0;
                let description = '';
                
                if (currentUser.userRules) {
                    const userRules = currentUser.userRules;
                    const passScore = (fullScore * userRules.passPercentage) / 100;
                    const rewardScore = (fullScore * userRules.rewardPercentage) / 100;
                    const doubleRewardScore = (fullScore * userRules.doubleRewardPercentage) / 100;
                    
                    if (score.score < passScore) {
                        // 处罚
                        points = -userRules.penaltyAmount;
                        description = `低于及格线 (${userRules.passPercentage}%)`;
                    } else if (score.score >= doubleRewardScore) {
                        // 双倍奖励 - 只计算超出标准的整数部分
                        const excessScore = Math.floor(score.score - doubleRewardScore);
                        points = excessScore * 20;
                        description = `双倍奖励线 (${userRules.doubleRewardPercentage}%+, 每分20元)`;
                    } else if (score.score >= rewardScore) {
                        // 奖励 - 只计算超出标准的整数部分
                        const excessScore = Math.floor(score.score - rewardScore);
                        points = excessScore * 10;
                        description = `奖励线 (${userRules.rewardPercentage}%+, 每分10元)`;
                    } else {
                        // 不奖不罚
                        points = 0;
                        description = `及格线以上 (${userRules.passPercentage}%-${userRules.rewardPercentage}%)`;
                    }
                } else {
                    // 使用默认规则
                    const rule = rewardRules.find(r => score.score >= r.minScore && score.score <= r.maxScore);
                    if (rule) {
                        if (rule.points > 0) {
                            // 只计算超出标准的整数部分
                            const excessScore = Math.floor(score.score - rule.minScore);
                            points = excessScore * rule.points;
                        } else if (rule.points < 0) {
                            points = rule.points;
                        }
                        description = rule.description;
                    }
                }
                
                totalRewardPoints += points;
                
                detailedRewards.push({
                    subject: score.subject,
                    score: score.score,
                    fullScore: fullScore,
                    points: points,
                    description: description
                });
            });
            
            // 创建奖励记录
            const rewardRecord = {
                id: rewardHistory.length + 1,
                userId: currentUser.id,
                username: currentUser.username,
                grade: currentUser.grade, // 保存用户当前年级信息
                scores: [...currentScores],
                totalPoints: totalRewardPoints,
                detailedRewards: detailedRewards,
                calculateTime: new Date().toISOString(),
                // 添加汇总信息
                summary: {
                    subjectCount: currentScores.length,
                    totalScore: currentScores.reduce((sum, s) => sum + s.score, 0),
                    examType: currentScores.length > 0 ? currentScores[0].examType : '',
                    examDate: currentScores.length > 0 ? currentScores[0].examDate : ''
                }
            };
            
            // 添加到奖励历史记录
            rewardHistory.push(rewardRecord);
            
            // 清空当前录入的成绩
            currentScores = [];
            updateCurrentScoresList();
            
            // 更新奖励历史记录
            updateRewardHistory();
            
            // 关闭奖励结果模态框
            document.getElementById('reward-result-modal').classList.add('hidden');
            
            // 隐藏所有科目录入完成提示
            document.getElementById('all-subjects-notification').classList.add('hidden');
            
            alert('成绩已成功提交并记录到奖励历史中！');
        }
        
        // 更新奖励历史记录
        function updateRewardHistory() {
            const rewardHistoryList = document.getElementById('reward-history-list');
            rewardHistoryList.innerHTML = '';
            
            // 获取当前用户的奖励历史记录
            const userRewardHistory = rewardHistory.filter(record => record.userId === currentUser.id);
            
            // 更新总记录数
            document.getElementById('total-records').textContent = userRewardHistory.length;
            
            // 分页
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const paginatedRecords = userRewardHistory.slice(startIndex, endIndex);
            
            if (paginatedRecords.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="8" class="py-4 text-center text-gray-500">暂无奖励记录</td>
                `;
                rewardHistoryList.appendChild(emptyRow);
                return;
            }
            
            let index = startIndex + 1;
            
            paginatedRecords.forEach(record => {
                // 为每条记录添加一个汇总行
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'bg-gray-50';
                summaryRow.innerHTML = `
                    <td class="py-3 px-4 font-semibold" rowspan="${record.scores.length}">${index}</td>
                    <td class="py-3 px-4 font-semibold" colspan="3">
                        ${record.summary.examType} - ${record.summary.examDate}
                    </td>
                    <td class="py-3 px-4 font-semibold ${record.totalPoints >= 0 ? 'text-success' : 'text-danger'}">
                        ${record.totalPoints >= 0 ? '+' : ''}${record.totalPoints}元
                    </td>
                    <td class="py-3 px-4 font-semibold" colspan="2">
                        ${record.summary.subjectCount} 科 - ${record.summary.totalScore.toFixed(1)}分
                    </td>
                    <td class="py-3 px-4 font-semibold">
                        ${new Date(record.calculateTime).toLocaleString()}
                    </td>
                `;
                rewardHistoryList.appendChild(summaryRow);
                
                // 添加详细成绩行
                record.detailedRewards.forEach((reward, rewardIndex) => {
                    if (rewardIndex === 0) return; // 第一行已经在汇总行中显示
                    
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-all-300';
                    row.innerHTML = `
                        <td class="py-3 px-4">${reward.subject}</td>
                        <td class="py-3 px-4">${reward.fullScore}</td>
                        <td class="py-3 px-4">${reward.score}</td>
                        <td class="py-3 px-4 ${reward.points >= 0 ? 'text-success' : 'text-danger'}">
                            ${reward.points >= 0 ? '+' : ''}${reward.points}元
                        </td>
                        <td class="py-3 px-4">-</td>
                        <td class="py-3 px-4">-</td>
                        <td class="py-3 px-4">-</td>
                    `;
                    rewardHistoryList.appendChild(row);
                });
                
                // 为第一条详细记录添加详情按钮
                if (record.detailedRewards.length > 0) {
                    const firstDetailRow = document.createElement('tr');
                    firstDetailRow.className = 'border-b border-gray-200 hover:bg-gray-50 transition-all-300';
                    firstDetailRow.innerHTML = `
                        <td class="py-3 px-4">${record.detailedRewards[0].subject}</td>
                        <td class="py-3 px-4">${record.detailedRewards[0].fullScore}</td>
                        <td class="py-3 px-4">${record.detailedRewards[0].score}</td>
                        <td class="py-3 px-4 ${record.detailedRewards[0].points >= 0 ? 'text-success' : 'text-danger'}">
                            ${record.detailedRewards[0].points >= 0 ? '+' : ''}${record.detailedRewards[0].points}元
                        </td>
                        <td class="py-3 px-4">-</td>
                        <td class="py-3 px-4">-</td>
                        <td class="py-3 px-4">
                            <button class="text-primary hover:text-blue-700 transition-all-300" onclick="showRewardDetail(${record.id})">
                                <i class="fa fa-info-circle"></i> 详情
                            </button>
                        </td>
                    `;
                    rewardHistoryList.appendChild(firstDetailRow);
                }
                
                index++;
            });
            
            // 更新分页按钮状态
            const prevPageButton = document.getElementById('prev-page');
            const nextPageButton = document.getElementById('next-page');
            const totalPages = Math.ceil(userRewardHistory.length / recordsPerPage);
            
            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = currentPage === totalPages;
            
            document.getElementById('current-page').textContent = currentPage;
        }
        
        // 显示奖励详情
        function showRewardDetail(recordId) {
            const record = rewardHistory.find(r => r.id === recordId);
            if (!record) return;
            
            let detailHtml = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">考试信息</h4>
                        <p><strong>考试类型：</strong>${record.summary.examType}</p>
                        <p><strong>考试日期：</strong>${record.summary.examDate}</p>
                        <p><strong>计算时间：</strong>${new Date(record.calculateTime).toLocaleString()}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">成绩汇总</h4>
                        <p><strong>科目数：</strong>${record.summary.subjectCount} 科</p>
                        <p><strong>总成绩：</strong>${record.summary.totalScore.toFixed(1)}</p>
                        <p><strong>奖罚总额：</strong><span class="${record.totalPoints >= 0 ? 'text-success' : 'text-danger'} font-bold">${record.totalPoints >= 0 ? '+' : ''}${record.totalPoints}元</span></p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">详细成绩</h4>
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-2">科目</th>
                                    <th class="text-left py-2">满分值</th>
                                    <th class="text-left py-2">成绩</th>
                                    <th class="text-left py-2">奖罚额</th>
                                    <th class="text-left py-2">说明</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            record.detailedRewards.forEach(reward => {
                detailHtml += `
                    <tr class="border-b">
                        <td class="py-2">${reward.subject}</td>
                        <td class="py-2">${reward.fullScore}</td>
                        <td class="py-2">${reward.score}</td>
                        <td class="py-2 ${reward.points >= 0 ? 'text-success' : 'text-danger'} font-bold">${reward.points >= 0 ? '+' : ''}${reward.points}元</td>
                        <td class="py-2">${reward.description}</td>
                    </tr>
                `;
            });
            
            detailHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-primary">奖励详情</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    ${detailHtml}
                    <div class="mt-6 text-center">
                        <button onclick="this.closest('.fixed').remove()" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // 更新用户列表
        function updateUsersList() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            
            // 排除管理员
            const nonAdminUsers = users.filter(user => !user.isAdmin);
            
            if (nonAdminUsers.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="4" class="py-4 text-center text-gray-500">暂无用户</td>
                `;
                usersList.appendChild(emptyRow);
                return;
            }
            
            nonAdminUsers.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-all-300';
                row.innerHTML = `
                    <td class="py-3 px-4">${user.username}</td>
                    <td class="py-3 px-4">${user.grade}</td>
                    <td class="py-3 px-4">${user.subjects ? user.subjects.length : 0}</td>
                    <td class="py-3 px-4">${user.registerTime}</td>
                    <td class="py-3 px-4">
                        <button class="text-primary hover:text-blue-700 transition-all-300 mr-2" onclick="editUserInfo(${user.id})">
                            <i class="fa fa-edit"></i> 编辑
                        </button>
                        <button class="text-success hover:text-green-700 transition-all-300 mr-2" onclick="resetUserPassword(${user.id})">
                            <i class="fa fa-key"></i> 重设密码
                        </button>
                        <button class="text-warning hover:text-yellow-700 transition-all-300 mr-2" onclick="manageUserSubjects(${user.id})">
                            <i class="fa fa-book"></i> 管理科目
                        </button>
                        <button class="text-info hover:text-blue-500 transition-all-300 mr-2" onclick="manageUserRules(${user.id})">
                            <i class="fa fa-sliders"></i> 管理规则
                        </button>
                        <button class="text-danger hover:text-red-700 transition-all-300" onclick="deleteUser(${user.id})">
                            <i class="fa fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                usersList.appendChild(row);
            });
        }
        
        // 编辑用户信息
        function editUserInfo(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            // 创建编辑用户信息模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 animate-slide-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-primary">编辑用户信息</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    <form id="edit-user-form" class="space-y-4">
                        <div>
                            <label for="edit-username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                            <input type="text" id="edit-username" value="${user.username}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300">
                        </div>
                        <div>
                            <label for="edit-grade" class="block text-sm font-medium text-gray-700 mb-1">年级</label>
                            <div class="relative">
                                <input type="text" id="edit-grade" list="edit-grade-options" value="${user.grade}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300">
                                <datalist id="edit-grade-options">
                                    <option value="初一">
                                    <option value="初二">
                                    <option value="初三">
                                    <option value="高一">
                                    <option value="高二">
                                    <option value="高三">
                                </datalist>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">提示：可以选择现有年级或直接输入新的年级名称</p>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all-300">
                                取消
                            </button>
                            <button type="submit" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                                保存修改
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 绑定表单提交事件
            document.getElementById('edit-user-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const newUsername = document.getElementById('edit-username').value.trim();
                const newGrade = document.getElementById('edit-grade').value.trim();
                
                if (!newUsername) {
                    alert('用户名不能为空！');
                    return;
                }
                
                if (!newGrade) {
                    alert('年级不能为空！');
                    return;
                }
                
                // 检查用户名是否已被其他用户使用
                const usernameExists = users.some(u => u.username === newUsername && u.id !== userId);
                if (usernameExists) {
                    alert('用户名已被使用，请选择其他用户名！');
                    return;
                }
                
                // 更新用户信息
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].username = newUsername;
                    users[userIndex].grade = newGrade;
                    
                    // 保存到本地存储
                    saveDataToLocalStorage();
                    
                    // 更新用户列表
                    updateUsersList();
                    
                    // 更新快速登录列表
                    generateQuickLoginUsers();
                    
                    // 关闭模态框
                    modal.remove();
                    
                    // 显示成功消息
                    showToast('用户信息更新成功！');
                }
            });
        }

        // 重设用户密码
        function resetUserPassword(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            if (confirm(`确定要重设用户 "${user.username}" 的密码吗？\n重设后的密码将为默认密码：user123`)) {
                // 更新用户密码
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].password = 'user123';
                    
                    // 保存到本地存储
                    saveDataToLocalStorage();
                    
                    // 显示成功消息
                    showToast(`用户 "${user.username}" 的密码已重设为：user123`);
                }
            }
        }

        // 显示Toast提示
        function showToast(message, type = 'success') {
            // 创建Toast元素
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in`;
            toast.textContent = message;
            
            // 添加到页面
            document.body.appendChild(toast);
            
            // 3秒后自动移除
            setTimeout(() => {
                toast.classList.add('animate-fade-out');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // 显示奖励记录详情
        function showRewardDetail(recordId) {
            const record = rewardHistory.find(r => r.id === recordId);
            if (!record) return;

            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in';
            modal.id = 'detail-modal';
            
            // 构建详情内容
            let detailContent = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-primary">奖励记录详情</h3>
                        <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-600 text-sm">用户</p>
                                <p class="font-semibold">${record.username}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">年级</p>
                                <p class="font-semibold">${record.grade}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">考试类型</p>
                                <p class="font-semibold">${record.summary.examType}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">考试日期</p>
                                <p class="font-semibold">${record.summary.examDate}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">科目数</p>
                                <p class="font-semibold">${record.summary.subjectCount} 科</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">总成绩</p>
                                <p class="font-semibold">${record.summary.totalScore.toFixed(1)}</p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-gray-600 text-sm">奖罚总额</p>
                                <p class="font-semibold text-xl ${record.totalPoints >= 0 ? 'text-success' : 'text-danger'}">
                                    ${record.totalPoints >= 0 ? '+' : ''}${record.totalPoints}元
                                </p>
                            </div>
                        </div>
                        
                        <h4 class="font-semibold text-gray-800 mt-4">详细成绩</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg overflow-hidden border">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 text-left text-sm font-semibold text-gray-700 border">科目</th>
                                        <th class="py-2 px-4 text-left text-sm font-semibold text-gray-700 border">满分值</th>
                                        <th class="py-2 px-4 text-left text-sm font-semibold text-gray-700 border">成绩</th>
                                        <th class="py-2 px-4 text-left text-sm font-semibold text-gray-700 border">奖罚额</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            record.detailedRewards.forEach(reward => {
                detailContent += `
                                    <tr>
                                        <td class="py-2 px-4 border">${reward.subject}</td>
                                        <td class="py-2 px-4 border">${reward.fullScore}</td>
                                        <td class="py-2 px-4 border">${reward.score}</td>
                                        <td class="py-2 px-4 border ${reward.points >= 0 ? 'text-success' : 'text-danger'}">
                                            ${reward.points >= 0 ? '+' : ''}${reward.points}元
                                        </td>
                                    </tr>
                `;
            });
            
            detailContent += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 text-right">
            `;
            
            // 管理员显示删除按钮，普通用户只显示关闭按钮
            if (currentUser && currentUser.isAdmin) {
                detailContent += `
                            <button onclick="closeDetailModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition-all-300 mr-2">
                                关闭
                            </button>
                            <button onclick="deleteAdminRewardRecord(${record.id}); closeDetailModal();" class="bg-danger hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                                <i class="fa fa-trash mr-2"></i>删除记录
                            </button>
                `;
            } else {
                detailContent += `
                            <button onclick="closeDetailModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition-all-300">
                                关闭
                            </button>
                `;
            }
            
            detailContent += `
                        </div>
                    </div>
                </div>
            `;
            
            modal.innerHTML = detailContent;
            document.body.appendChild(modal);
        }

        // 关闭详情模态框
        function closeDetailModal() {
            const modal = document.getElementById('detail-modal');
            if (modal) {
                modal.classList.add('animate-fade-out');
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            }
        }

        

        // 删除用户
        function deleteUser(id) {
            if (confirm('确定要删除该用户吗？删除后该用户的所有奖励记录也将被删除！')) {
                // 编辑用户信息
        function editUserInfo(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            // 创建编辑用户信息模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 animate-slide-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-primary">编辑用户信息</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    <form id="edit-user-form" class="space-y-4">
                        <div>
                            <label for="edit-username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                            <input type="text" id="edit-username" value="${user.username}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300">
                        </div>
                        <div>
                            <label for="edit-grade" class="block text-sm font-medium text-gray-700 mb-1">年级</label>
                            <div class="relative">
                                <input type="text" id="edit-grade" list="edit-grade-options" value="${user.grade}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300">
                                <datalist id="edit-grade-options">
                                    <option value="初一">
                                    <option value="初二">
                                    <option value="初三">
                                    <option value="高一">
                                    <option value="高二">
                                    <option value="高三">
                                </datalist>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">提示：可以选择现有年级或直接输入新的年级名称</p>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all-300">
                                取消
                            </button>
                            <button type="submit" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
                                保存修改
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 绑定表单提交事件
            document.getElementById('edit-user-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const newUsername = document.getElementById('edit-username').value.trim();
                const newGrade = document.getElementById('edit-grade').value.trim();
                
                if (!newUsername) {
                    alert('用户名不能为空！');
                    return;
                }
                
                if (!newGrade) {
                    alert('年级不能为空！');
                    return;
                }
                
                // 检查用户名是否已被其他用户使用
                const usernameExists = users.some(u => u.username === newUsername && u.id !== userId);
                if (usernameExists) {
                    alert('用户名已被使用，请选择其他用户名！');
                    return;
                }
                
                // 更新用户信息
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].username = newUsername;
                    users[userIndex].grade = newGrade;
                    
                    // 保存到本地存储
                    saveDataToLocalStorage();
                    
                    // 更新用户列表
                    updateUsersList();
                    
                    // 更新快速登录列表
                    generateQuickLoginUsers();
                    
                    // 关闭模态框
                    modal.remove();
                    
                    // 显示成功消息
                    showToast('用户信息更新成功！');
                }
            });
        }

        // 重设用户密码
        function resetUserPassword(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            if (confirm(`确定要重设用户 "${user.username}" 的密码吗？\n重设后的密码将为默认密码：user123`)) {
                // 更新用户密码
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].password = 'user123';
                    
                    // 保存到本地存储
                    saveDataToLocalStorage();
                    
                    // 显示成功消息
                    showToast(`用户 "${user.username}" 的密码已重设为：user123`);
                }
            }
        }

        // 删除用户
                users = users.filter(user => user.id !== id);
                // 删除该用户的所有奖励记录
                rewardHistory = rewardHistory.filter(record => record.userId !== id);
                updateUsersList();
                generateQuickLoginUsers();
                // 如果当前在奖励记录管理页面，更新记录列表
                if (!document.getElementById('reward-records-content').classList.contains('hidden')) {
                    updateAdminRewardRecords();
                }
            }
        }
        
        // 添加用户
        function addUser() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const grade = document.getElementById('new-grade').value;
            
            // 验证用户名是否已存在
            if (users.some(user => user.username === username)) {
                alert('用户名已存在！');
                return;
            }
            
            // 验证输入
            if (!username || !password || !grade) {
                alert('请填写完整的用户信息！');
                return;
            }
            
            // 创建新用户
            const newUser = {
                id: users.length + 1,
                username: username,
                password: password,
                isAdmin: false,
                grade: grade,
                registerTime: new Date().toISOString().split('T')[0]
            };
            
            users.push(newUser);
            
            // 更新用户列表
            updateUsersList();
            
            // 更新快速登录用户
            generateQuickLoginUsers();
            
            // 关闭添加用户模态框
            document.getElementById('add-user-modal').classList.add('hidden');
            
            // 清空表单
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('new-grade').value = '';
            
            alert('用户添加成功！');
        }
        
        // 更新年级列表
        function updateGradesList() {
            const gradesList = document.getElementById('grades-list');
            gradesList.innerHTML = '';
            
            grades.forEach((grade, index) => {
                const gradeItem = document.createElement('div');
                gradeItem.className = 'flex justify-between items-center p-2 bg-white rounded';
                gradeItem.innerHTML = `
                    <span>${grade}</span>
                    <button class="text-danger hover:text-red-700 transition-all-300" onclick="deleteGrade(${index})">
                        <i class="fa fa-trash"></i>
                    </button>
                `;
                gradesList.appendChild(gradeItem);
            });
        }
        
        // 删除年级
        function deleteGrade(index) {
            if (confirm('确定要删除该年级吗？')) {
                grades.splice(index, 1);
                updateGradesList();
            }
        }
        
        // 添加年级
        function addGrade() {
            const gradeName = document.getElementById('new-grade-name').value;
            
            if (!gradeName) {
                alert('请输入年级名称！');
                return;
            }
            
            if (grades.includes(gradeName)) {
                alert('该年级已存在！');
                return;
            }
            
            grades.push(gradeName);
            updateGradesList();
            
            // 关闭添加年级模态框
            document.getElementById('add-grade-modal').classList.add('hidden');
            
            // 清空表单
            document.getElementById('new-grade-name').value = '';
            
            alert('年级添加成功！');
        }
        
        // 初始化管理员奖励记录管理相关事件
        function initAdminRewardRecordsEvents() {
            // 刷新按钮点击事件
            const refreshButton = document.getElementById('refresh-records-button');
            if (refreshButton) {
                refreshButton.addEventListener('click', updateAdminRewardRecords);
            }
            
            // 用户筛选下拉框变更事件
            const userFilter = document.getElementById('admin-user-filter');
            if (userFilter) {
                userFilter.addEventListener('change', updateAdminRewardRecords);
            }
            
            // 分页按钮点击事件
            const prevPageButton = document.getElementById('admin-prev-page');
            const nextPageButton = document.getElementById('admin-next-page');
            
            if (prevPageButton) {
                prevPageButton.addEventListener('click', function() {
                    if (adminCurrentPage > 1) {
                        adminCurrentPage--;
                        updateAdminRewardRecords();
                    }
                });
            }
            
            if (nextPageButton) {
                nextPageButton.addEventListener('click', function() {
                    const userFilter = document.getElementById('admin-user-filter').value;
                    const filteredRecords = userFilter === 'all' ? rewardHistory : rewardHistory.filter(record => record.userId.toString() === userFilter);
                    const totalPages = Math.ceil(filteredRecords.length / adminRecordsPerPage);
                    
                    if (adminCurrentPage < totalPages) {
                        adminCurrentPage++;
                        updateAdminRewardRecords();
                    }
                });
            }
        }
        
        // 更新管理员奖励记录列表
        function updateAdminRewardRecords() {
            const recordsList = document.getElementById('admin-reward-records-list');
            const userFilter = document.getElementById('admin-user-filter').value;
            const totalRecordsElement = document.getElementById('admin-total-records');
            
            // 更新用户筛选下拉框
            updateAdminUserFilter();
            
            // 筛选记录
            const filteredRecords = userFilter === 'all' ? rewardHistory : rewardHistory.filter(record => record.userId.toString() === userFilter);
            
            // 更新总记录数
            totalRecordsElement.textContent = `总记录数: ${filteredRecords.length}`;
            
            // 分页
            const startIndex = (adminCurrentPage - 1) * adminRecordsPerPage;
            const endIndex = startIndex + adminRecordsPerPage;
            const paginatedRecords = filteredRecords.slice(startIndex, endIndex);
            
            recordsList.innerHTML = '';
            
            if (paginatedRecords.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="8" class="py-4 text-center text-gray-500">暂无奖励记录</td>
                `;
                recordsList.appendChild(emptyRow);
                return;
            }
            
            let index = startIndex + 1;
            
            paginatedRecords.forEach(record => {
                // 为每条记录添加一个汇总行
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'bg-gray-50';
                summaryRow.innerHTML = `
                    <td class="py-3 px-4 font-semibold" rowspan="${record.scores.length}">${index}</td>
                    <td class="py-3 px-4 font-semibold" rowspan="${record.scores.length}">${record.username}</td>
                    <td class="py-3 px-4 font-semibold" colspan="2">
                        ${record.summary.examType} - ${record.summary.examDate}
                    </td>
                    <td class="py-3 px-4 font-semibold">${record.summary.subjectCount} 科</td>
                    <td class="py-3 px-4 font-semibold">${record.summary.totalScore.toFixed(1)}</td>
                    <td class="py-3 px-4 font-semibold ${record.totalPoints >= 0 ? 'text-success' : 'text-danger'}">
                        ${record.totalPoints >= 0 ? '+' : ''}${record.totalPoints}元
                    </td>
                    <td class="py-3 px-4 font-semibold" colspan="2">
                        ${new Date(record.calculateTime).toLocaleString()}
                    </td>
                `;
                recordsList.appendChild(summaryRow);
                
                // 添加详细成绩行
                record.detailedRewards.forEach((reward, rewardIndex) => {
                    if (rewardIndex === 0) return; // 第一行已经在汇总行中显示
                    
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-all-300';
                    row.innerHTML = `
                        <td class="py-3 px-4">${reward.subject}</td>
                        <td class="py-3 px-4">${reward.fullScore}</td>
                        <td class="py-3 px-4">${reward.score}</td>
                        <td class="py-3 px-4">-</td>
                        <td class="py-3 px-4">-</td>
                        <td class="py-3 px-4 ${reward.points >= 0 ? 'text-success' : 'text-danger'}">
                            ${reward.points >= 0 ? '+' : ''}${reward.points}元
                        </td>
                        <td class="py-3 px-4">
                            <button class="text-primary hover:text-blue-700 transition-all-300" onclick="showRewardDetail(${record.id})">
                                <i class="fa fa-info-circle"></i> 详情
                            </button>
                        </td>
                    `;
                    recordsList.appendChild(row);
                });
                
                // 为第一条详细记录添加详情和删除按钮
                if (record.detailedRewards.length > 0) {
                    const firstDetailRow = document.createElement('tr');
                    firstDetailRow.className = 'border-b border-gray-200 hover:bg-gray-50 transition-all-300';
                    firstDetailRow.innerHTML = `
                        <td class="py-3 px-4">${record.detailedRewards[0].subject}</td>
                        <td class="py-3 px-4">${record.detailedRewards[0].fullScore}</td>
                        <td class="py-3 px-4">${record.detailedRewards[0].score}</td>
                        <td class="py-3 px-4">-</td>
                        <td class="py-3 px-4">-</td>
                        <td class="py-3 px-4 ${record.detailedRewards[0].points >= 0 ? 'text-success' : 'text-danger'}">
                            ${record.detailedRewards[0].points >= 0 ? '+' : ''}${record.detailedRewards[0].points}元
                        </td>
                        <td class="py-3 px-4">
                            <button class="text-primary hover:text-blue-700 transition-all-300" onclick="showRewardDetail(${record.id})">
                                <i class="fa fa-info-circle"></i> 详情
                            </button>
                        </td>
                    `;
                    recordsList.appendChild(firstDetailRow);
                }
                
                index++;
            });
            
            // 更新分页按钮状态
            const prevPageButton = document.getElementById('admin-prev-page');
            const nextPageButton = document.getElementById('admin-next-page');
            const totalPages = Math.ceil(filteredRecords.length / adminRecordsPerPage);
            
            prevPageButton.disabled = adminCurrentPage === 1;
            nextPageButton.disabled = adminCurrentPage === totalPages;
            
            document.getElementById('admin-current-page').textContent = adminCurrentPage;
        }
        
        // 更新管理员用户筛选下拉框
        function updateAdminUserFilter() {
            const userFilter = document.getElementById('admin-user-filter');
            const currentValue = userFilter.value;
            
            userFilter.innerHTML = '';
            
            // 添加默认选项
            const defaultOption = document.createElement('option');
            defaultOption.value = 'all';
            defaultOption.textContent = '所有用户';
            userFilter.appendChild(defaultOption);
            
            // 添加所有非管理员用户
            const nonAdminUsers = users.filter(user => !user.isAdmin);
            nonAdminUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.username} (${user.grade})`;
                userFilter.appendChild(option);
            });
            
            // 恢复当前选择的值
            userFilter.value = currentValue;
        }
        
        // 删除管理员奖励记录
        function deleteAdminRewardRecord(recordId) {
            if (confirm('确定要删除这条奖励记录吗？删除后无法恢复！')) {
                // 查找要删除的记录
                const recordToDelete = rewardHistory.find(record => record.id === recordId);
                if (!recordToDelete) {
                    showToast('记录不存在或已被删除！', 'error');
                    return;
                }
                
                // 记录删除前的筛选条件和分页信息
                const userFilter = document.getElementById('admin-user-filter').value;
                const filteredRecordsBeforeDelete = userFilter === 'all' ? 
                    rewardHistory.filter(record => record.id !== recordId) : 
                    rewardHistory.filter(record => record.id !== recordId && record.userId.toString() === userFilter);
                
                const recordsPerPage = adminRecordsPerPage;
                const totalPagesBeforeDelete = Math.ceil(filteredRecordsBeforeDelete.length / recordsPerPage);
                
                // 如果当前页是最后一页且删除后当前页会变空，则调整页码
                if (adminCurrentPage > totalPagesBeforeDelete && totalPagesBeforeDelete > 0) {
                    adminCurrentPage = totalPagesBeforeDelete;
                }
                
                // 删除记录
                rewardHistory = rewardHistory.filter(record => record.id !== recordId);
                
                // 更新管理员界面的记录列表
                updateAdminRewardRecords();
                
                // 如果当前有普通用户登录，并且删除的是该用户的记录，则更新用户界面的奖励历史
                if (currentUser && !currentUser.isAdmin && recordToDelete.userId === currentUser.id) {
                    updateRewardHistory();
                }
                
                // 显示成功提示
                showToast('奖励记录删除成功！');
            }
        }
        
        // 更新科目列表
        function updateSubjectsList() {
            const subjectsList = document.getElementById('subjects-list');
            subjectsList.innerHTML = '';
            
            subjects.forEach((subject, index) => {
                const subjectItem = document.createElement('div');
                subjectItem.className = 'flex justify-between items-center p-2 bg-white rounded';
                subjectItem.innerHTML = `
                    <span>${subject}</span>
                    <button class="text-danger hover:text-red-700 transition-all-300" onclick="deleteSubject(${index})">
                        <i class="fa fa-trash"></i>
                    </button>
                `;
                subjectsList.appendChild(subjectItem);
            });
        }
        
        // 删除科目
        function deleteSubject(index) {
            if (confirm('确定要删除该科目吗？')) {
                subjects.splice(index, 1);
                updateSubjectsList();
            }
        }
        
        // 添加科目
        function addSubject() {
            const subjectName = document.getElementById('new-subject-name').value;
            
            if (!subjectName) {
                alert('请输入科目名称！');
                return;
            }
            
            if (subjects.includes(subjectName)) {
                alert('该科目已存在！');
                return;
            }
            
            subjects.push(subjectName);
            updateSubjectsList();
            
            // 关闭添加科目模态框
            document.getElementById('add-subject-modal').classList.add('hidden');
            
            // 清空表单
            document.getElementById('new-subject-name').value = '';
            
            alert('科目添加成功！');
        }
        
        // 更新规则列表
        function updateRulesList() {
            const rulesList = document.getElementById('rules-list');
            rulesList.innerHTML = '';
            
            rewardRules.forEach((rule, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-all-300';
                row.innerHTML = `
                    <td class="py-3 px-4">${rule.minScore}-${rule.maxScore}分</td>
                    <td class="py-3 px-4">${rule.points}分</td>
                    <td class="py-3 px-4">${rule.description}</td>
                    <td class="py-3 px-4">
                        <button class="text-danger hover:text-red-700 transition-all-300" onclick="deleteRule(${index})">
                            <i class="fa fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                rulesList.appendChild(row);
            });
        }
        
        // 删除规则
        function deleteRule(index) {
            if (confirm('确定要删除该规则吗？')) {
                rewardRules.splice(index, 1);
                updateRulesList();
            }
        }
        
        // 添加规则
        function addRule() {
            const minScore = parseInt(document.getElementById('min-score').value);
            const maxScore = parseInt(document.getElementById('max-score').value);
            const points = parseInt(document.getElementById('reward-points').value);
            const description = document.getElementById('rule-description').value;
            
            // 验证输入
            if (isNaN(minScore) || isNaN(maxScore) || isNaN(points) || !description) {
                alert('请填写完整的规则信息！');
                return;
            }
            
            // 验证分数范围
            if (minScore < 0 || maxScore > 100 || minScore > maxScore) {
                alert('分数范围无效！');
                return;
            }
            
            // 验证分数范围是否重叠
            const isOverlap = rewardRules.some(rule => 
                (minScore >= rule.minScore && minScore <= rule.maxScore) || 
                (maxScore >= rule.minScore && maxScore <= rule.maxScore) ||
                (minScore <= rule.minScore && maxScore >= rule.maxScore)
            );
            
            if (isOverlap) {
                alert('分数范围与现有规则重叠！');
                return;
            }
            
            // 创建新规则
            const newRule = {
                id: rewardRules.length + 1,
                minScore: minScore,
                maxScore: maxScore,
                points: points,
                description: description
            };
            
            rewardRules.push(newRule);
            
            // 按最低分数排序
            rewardRules.sort((a, b) => a.minScore - b.minScore);
            
            // 更新规则列表
            updateRulesList();
            
            // 关闭添加规则模态框
            document.getElementById('add-rule-modal').classList.add('hidden');
            
            // 清空表单
            document.getElementById('min-score').value = '';
            document.getElementById('max-score').value = '';
            document.getElementById('reward-points').value = '';
            document.getElementById('rule-description').value = '';
            
            alert('规则添加成功！');
        }
        
        // 修改管理员密码
        function changeAdminPassword() {
            const currentPassword = document.getElementById('current-admin-password').value;
            const newPassword = document.getElementById('new-admin-password').value;
            const confirmPassword = document.getElementById('confirm-admin-password').value;
            
            // 验证当前密码
            const adminUser = users.find(user => user.isAdmin);
            if (adminUser.password !== currentPassword) {
                alert('当前密码错误！');
                return;
            }
            
            // 验证新密码
            if (newPassword !== confirmPassword) {
                alert('两次输入的新密码不一致！');
                return;
            }
            
            // 更新密码
            adminUser.password = newPassword;
            
            // 清空表单
            document.getElementById('current-admin-password').value = '';
            document.getElementById('new-admin-password').value = '';
            document.getElementById('confirm-admin-password').value = '';
            
            alert('密码修改成功！');
        }
        
        // 管理用户科目
        let currentManagingUser = null;
        
        function manageUserSubjects(userId) {
            currentManagingUser = users.find(user => user.id === userId);
            
            if (!currentManagingUser) {
                alert('用户不存在！');
                return;
            }
            
            // 确保用户有subjects属性
            if (!currentManagingUser.subjects) {
                currentManagingUser.subjects = [];
            }
            
            // 更新当前科目列表
            const currentSubjectsList = document.getElementById('current-subjects-list');
            currentSubjectsList.innerHTML = '';
            
            if (currentManagingUser.subjects.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'text-gray-500 text-center py-2';
                emptyItem.textContent = '暂无科目';
                currentSubjectsList.appendChild(emptyItem);
            } else {
                currentManagingUser.subjects.forEach(subject => {
                    const subjectItem = document.createElement('li');
                    subjectItem.className = 'flex justify-between items-center p-2 bg-white rounded';
                    subjectItem.innerHTML = `
                        <div>
                            <span class="font-medium">${subject.name}</span>
                            <span class="text-sm text-gray-500 ml-2">(${subject.fullScore}分)</span>
                        </div>
                        <button class="text-danger hover:text-red-700 transition-all-300" onclick="removeSubjectFromUser('${subject.name}')">
                            <i class="fa fa-minus-circle"></i>
                        </button>
                    `;
                    currentSubjectsList.appendChild(subjectItem);
                });
            }
            
            // 更新可选科目列表
            const availableSubjectsList = document.getElementById('available-subjects-list');
            availableSubjectsList.innerHTML = '';
            
            const availableSubjects = subjects.filter(subject => 
                !currentManagingUser.subjects.some(s => s.name === subject.name)
            );
            
            if (availableSubjects.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'text-gray-500 text-center py-2';
                emptyItem.textContent = '暂无可选科目';
                availableSubjectsList.appendChild(emptyItem);
            } else {
                availableSubjects.forEach(subject => {
                    const subjectItem = document.createElement('li');
                    subjectItem.className = 'flex justify-between items-center p-2 bg-white rounded';
                    subjectItem.innerHTML = `
                        <div>
                            <span class="font-medium">${subject.name}</span>
                            <span class="text-sm text-gray-500 ml-2">(${subject.fullScore}分)</span>
                        </div>
                        <div>
                            <button class="text-primary hover:text-blue-700 transition-all-300 mr-2" onclick="editSubject('${subject.name}')">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="text-success hover:text-green-700 transition-all-300" onclick="addSubjectToUser('${subject.name}')">
                                <i class="fa fa-plus-circle"></i>
                            </button>
                        </div>
                    `;
                    availableSubjectsList.appendChild(subjectItem);
                });
            }
            
            // 显示用户科目管理模态框
            document.getElementById('user-subjects-modal').classList.remove('hidden');
        }
        
        // 从用户移除科目
        function removeSubjectFromUser(subjectName) {
            if (!currentManagingUser) return;
            
            currentManagingUser.subjects = currentManagingUser.subjects.filter(s => s.name !== subjectName);
            
            // 重新加载科目列表
            manageUserSubjects(currentManagingUser.id);
        }
        
        // 向用户添加科目
        function addSubjectToUser(subjectName) {
            if (!currentManagingUser) return;
            
            const subjectToAdd = subjects.find(s => s.name === subjectName);
            if (!subjectToAdd) return;
            
            if (!currentManagingUser.subjects.some(s => s.name === subjectName)) {
                currentManagingUser.subjects.push(subjectToAdd);
            }
            
            // 重新加载科目列表
            manageUserSubjects(currentManagingUser.id);
        }
        
        // 保存用户科目更改
        function saveUserSubjectsChanges() {
            if (!currentManagingUser) return;
            
            // 更新用户列表
            updateUsersList();
            
            // 关闭模态框
            document.getElementById('user-subjects-modal').classList.add('hidden');
            
            // 重置当前管理用户
            currentManagingUser = null;
            
            alert('科目管理成功！');
        }
        
        // 编辑科目
        let currentEditingSubject = null;
        
        function editSubject(subjectName) {
            const subject = subjects.find(s => s.name === subjectName);
            if (!subject) {
                alert('科目不存在！');
                return;
            }
            
            currentEditingSubject = subject;
            
            // 填充表单数据
            document.getElementById('edit-subject-name').value = subject.name;
            document.getElementById('edit-subject-full-score').value = subject.fullScore;
            
            // 显示编辑科目模态框
            document.getElementById('edit-subject-modal').classList.remove('hidden');
        }
        
        // 保存编辑的科目
        function saveEditedSubject() {
            if (!currentEditingSubject) return;
            
            const newFullScore = parseInt(document.getElementById('edit-subject-full-score').value);
            
            // 验证输入
            if (isNaN(newFullScore) || newFullScore <= 0) {
                alert('请输入有效的满分值！');
                return;
            }
            
            // 更新科目满分值
            currentEditingSubject.fullScore = newFullScore;
            
            // 更新所有使用该科目的用户
            users.forEach(user => {
                if (user.subjects) {
                    user.subjects.forEach(subject => {
                        if (subject.name === currentEditingSubject.name) {
                            subject.fullScore = newFullScore;
                        }
                    });
                }
            });
            
            // 更新科目列表
            updateSubjectsList();
            
            // 如果当前正在管理用户科目，则刷新列表
            if (currentManagingUser) {
                manageUserSubjects(currentManagingUser.id);
            }
            
            // 关闭模态框
            document.getElementById('edit-subject-modal').classList.add('hidden');
            
            // 重置当前编辑科目
            currentEditingSubject = null;
            
            alert('科目编辑成功！');
        }
        
        // 管理用户奖励规则
        let currentManagingUserRules = null;
        
        function manageUserRules(userId) {
            currentManagingUserRules = users.find(user => user.id === userId);
            
            if (!currentManagingUserRules) {
                alert('用户不存在！');
                return;
            }
            
            // 确保用户有userRules属性
            if (!currentManagingUserRules.userRules) {
                currentManagingUserRules.userRules = {
                    passPercentage: 60,
                    rewardPercentage: 90,
                    doubleRewardPercentage: 96,
                    penaltyAmount: 10
                };
            }
            
            // 填充表单数据
            document.getElementById('pass-percentage').value = currentManagingUserRules.userRules.passPercentage;
            document.getElementById('reward-percentage').value = currentManagingUserRules.userRules.rewardPercentage;
            document.getElementById('double-reward-percentage').value = currentManagingUserRules.userRules.doubleRewardPercentage;
            document.getElementById('penalty-amount').value = currentManagingUserRules.userRules.penaltyAmount;
            
            // 显示用户奖励规则管理模态框
            document.getElementById('user-rules-modal').classList.remove('hidden');
        }
        
        // 保存用户奖励规则
        function saveUserRules() {
            if (!currentManagingUserRules) return;
            
            const passPercentage = parseInt(document.getElementById('pass-percentage').value);
            const rewardPercentage = parseInt(document.getElementById('reward-percentage').value);
            const doubleRewardPercentage = parseInt(document.getElementById('double-reward-percentage').value);
            const penaltyAmount = parseInt(document.getElementById('penalty-amount').value);
            
            // 验证输入
            if (isNaN(passPercentage) || isNaN(rewardPercentage) || isNaN(doubleRewardPercentage) || isNaN(penaltyAmount)) {
                alert('请填写完整的规则信息！');
                return;
            }
            
            // 验证百分比范围
            if (passPercentage < 0 || passPercentage > 100 || rewardPercentage < 0 || rewardPercentage > 100 || doubleRewardPercentage < 0 || doubleRewardPercentage > 100) {
                alert('百分比必须在0-100之间！');
                return;
            }
            
            // 验证处罚金额
            if (penaltyAmount < 0) {
                alert('处罚金额不能为负数！');
                return;
            }
            
            // 验证分数线逻辑
            if (passPercentage >= rewardPercentage) {
                alert('及格线必须低于奖励线！');
                return;
            }
            
            if (rewardPercentage >= doubleRewardPercentage) {
                alert('奖励线必须低于双倍奖励线！');
                return;
            }
            
            // 更新用户奖励规则
            currentManagingUserRules.userRules = {
                passPercentage: passPercentage,
                rewardPercentage: rewardPercentage,
                doubleRewardPercentage: doubleRewardPercentage,
                penaltyAmount: penaltyAmount
            };
            
            // 如果当前用户正在查看自己的规则，更新显示
            if (currentUser && currentUser.id === currentManagingUserRules.id) {
                updateUserRulesDisplay();
            }
            
            // 关闭模态框
            document.getElementById('user-rules-modal').classList.add('hidden');
            
            // 重置当前管理用户
            currentManagingUserRules = null;
            
            alert('用户奖励规则设置成功！');
        }
        
        // 更新用户奖励规则显示
        function updateUserRulesDisplay() {
            const rulesContainer = document.getElementById('reward-rules');
            const rulesDisplayContainer = document.getElementById('user-rules-display');
            
            // 获取用户规则或使用默认规则
            let rules = {
                passPercentage: 60,
                rewardPercentage: 90,
                doubleRewardPercentage: 96,
                penaltyAmount: 10
            };
            
            if (currentUser && currentUser.userRules) {
                rules = currentUser.userRules;
            }
            
            // 生成规则HTML
            const rulesHTML = `
                <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-primary">
                    <h4 class="font-semibold text-primary">双倍奖励线 (${rules.doubleRewardPercentage}%-100%)</h4>
                    <p>奖励金额: <span class="font-bold text-success">每分20元</span></p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg border-l-4 border-success">
                    <h4 class="font-semibold text-success">奖励线 (${rules.rewardPercentage}%-${rules.doubleRewardPercentage - 1}%)</h4>
                    <p>奖励金额: <span class="font-bold text-success">每分10元</span></p>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg border-l-4 border-warning">
                    <h4 class="font-semibold text-warning">及格线 (${rules.passPercentage}%-${rules.rewardPercentage - 1}%)</h4>
                    <p>奖励金额: <span class="font-bold text-gray-600">不奖不罚</span></p>
                </div>
                <div class="p-4 bg-red-50 rounded-lg border-l-4 border-danger">
                    <h4 class="font-semibold text-danger">处罚线 (0-${rules.passPercentage - 1}%)</h4>
                    <p>处罚金额: <span class="font-bold text-danger">每科扣${rules.penaltyAmount}元</span></p>
                </div>
            `;
            
            // 生成简化版规则显示HTML
            const rulesDisplayHTML = `
                <h4 class="font-semibold text-primary mb-2">当前奖励规则</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>双倍奖励线:</span>
                        <span class="font-medium text-primary">${rules.doubleRewardPercentage}%+ (每分20元)</span>
                    </div>
                    <div class="flex justify-between">
                        <span>奖励线:</span>
                        <span class="font-medium text-success">${rules.rewardPercentage}%+ (每分10元)</span>
                    </div>
                    <div class="flex justify-between">
                        <span>及格线:</span>
                        <span class="font-medium text-warning">${rules.passPercentage}%+ (不奖不罚)</span>
                    </div>
                    <div class="flex justify-between">
                        <span>处罚线:</span>
                        <span class="font-medium text-danger">&lt;${rules.passPercentage}% (每科扣${rules.penaltyAmount}元)</span>
                    </div>
                </div>
            `;
            
            // 更新显示
            rulesContainer.innerHTML = rulesHTML;
            if (rulesDisplayContainer) {
                rulesDisplayContainer.innerHTML = rulesDisplayHTML;
            }
        }
    </script>
</body>
</html>